<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settlement Calculator - Splitzee</title>
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Splitzee">
    <meta name="theme-color" content="#6200EE">
    
    <!-- Storage System -->
    <script src="js/offline-storage.js?v=19"></script>
    <script src="js/supabase-integration.js?v=19"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background-color: #f5f5f5;
            color: #333;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #8B5FBF 0%, #6B46C1 50%, #553C9A 100%);
            color: white;
            padding: 20px;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 8px rgba(139, 95, 191, 0.3);
        }

        .back-button {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            margin-right: 16px;
            padding: 8px;
            cursor: pointer;
        }

        .header-title {
            font-size: 20px;
            font-weight: 600;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 16px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .balance-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .balance-item:last-child {
            border-bottom: none;
        }

        .person-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .person-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #8B5FBF, #6B46C1);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 16px;
        }

        .person-name {
            font-size: 16px;
            font-weight: 500;
        }

        .balance-amount {
            font-size: 18px;
            font-weight: 600;
        }

        .balance-amount.positive {
            color: #4CAF50;
        }

        .balance-amount.negative {
            color: #f44336;
        }

        .balance-amount.neutral {
            color: #666;
        }

        .settlement-item {
            display: flex;
            align-items: center;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 12px;
            margin-bottom: 12px;
            border-left: 4px solid #6200EE;
        }

        .settlement-arrow {
            margin: 0 16px;
            font-size: 20px;
            color: #6200EE;
        }

        .settlement-amount {
            margin-left: auto;
            font-size: 18px;
            font-weight: 600;
            color: #6200EE;
        }

        .toggle-view {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .toggle-button {
            flex: 1;
            background: white;
            border: 2px solid #e0e0e0;
            color: #666;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .toggle-button.active {
            background: linear-gradient(135deg, #8B5FBF, #6B46C1);
            color: white;
            border-color: #8B5FBF;
        }

        .share-button {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            border: none;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        .share-button:active {
            transform: scale(0.98);
        }

        .direct-debt {
            background: #fff3e0;
            border-left-color: #ff9800;
        }

        .optimized-debt {
            background: #e8f5e8;
            border-left-color: #4CAF50;
        }

        .info-box {
            background: #e3f2fd;
            border: 1px solid #2196F3;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
            color: #1976D2;
            font-size: 14px;
            line-height: 1.5;
        }

        .expense-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            margin-bottom: 16px;
        }

        .summary-item {
            text-align: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .summary-value {
            font-size: 24px;
            font-weight: 600;
            color: #8B5FBF;
        }

        .summary-label {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <div class="header">
        <button class="back-button" onclick="goBack()">‚Üê</button>
        <div class="header-title">Settlement Calculator</div>
    </div>

    <div class="container">
        <!-- Summary Card -->
        <div class="card">
            <div class="section-title">üìä Trip Summary</div>
            <div class="expense-summary">
                <div class="summary-item">
                    <div class="summary-value" id="totalExpenses">$0</div>
                    <div class="summary-label">Total Spent</div>
                </div>
                <div class="summary-item">
                    <div class="summary-value" id="expenseCount">0</div>
                    <div class="summary-label">Expenses</div>
                </div>
                <div class="summary-item">
                    <div class="summary-value" id="participantCount">0</div>
                    <div class="summary-label">People</div>
                </div>
            </div>
        </div>

        <!-- Individual Balances -->
        <div class="card">
            <div class="section-title">üí∞ Individual Balances</div>
            <div class="info-box">
                üí° <strong>Green</strong> = gets money back, <strong>Red</strong> = owes money, <strong>Gray</strong> = all settled up
            </div>
            <div id="balancesList">
                <div class="balance-item">
                    <div class="person-info">
                        <div class="person-avatar">Y</div>
                        <div class="person-name">You</div>
                    </div>
                    <div class="balance-amount neutral">$0.00</div>
                </div>
            </div>
        </div>

        <!-- Settlement Options -->
        <div class="card">
            <div class="section-title">‚öñÔ∏è How to Settle Up</div>
            
            <div class="toggle-view">
                <button class="toggle-button active" onclick="showView('optimized')" id="optimizedBtn">
                    ‚ú® Optimized (Recommended)
                </button>
                <button class="toggle-button" onclick="showView('direct')" id="directBtn">
                    üìã Direct Debts
                </button>
            </div>

            <div id="optimizedView">
                <div class="info-box">
                    ‚ú® <strong>Optimized settlements</strong> minimize the number of transactions needed. This is the most efficient way to settle up.
                </div>
                <div id="optimizedSettlements">
                    <!-- Settlements will be populated dynamically -->
                </div>
            </div>

            <div id="directView" style="display: none;">
                <div class="info-box">
                    üìã <strong>Direct debts</strong> show exactly who owes whom based on who paid for what. This matches your receipts exactly.
                </div>
                <div id="directSettlements">
                    <!-- Direct settlements will be populated here -->
                </div>
            </div>

            <button class="share-button" onclick="shareSettlement()">
                üìß Share Settlement Report
            </button>
        </div>
    </div>

    <script>
        let currentView = 'optimized';
        let settlementData = {
            balances: {},
            directDebts: [],
            optimizedSettlements: [],
            totalExpenses: 0,
            expenseCount: 0
        };

        function showView(view) {
            currentView = view;
            
            // Update toggle buttons
            document.getElementById('optimizedBtn').classList.toggle('active', view === 'optimized');
            document.getElementById('directBtn').classList.toggle('active', view === 'direct');
            
            // Show/hide views
            document.getElementById('optimizedView').style.display = view === 'optimized' ? 'block' : 'none';
            document.getElementById('directView').style.display = view === 'direct' ? 'block' : 'none';
        }

        function calculateSettlements(expenses) {
            const balances = {};
            const directDebts = [];
            let totalExpenses = 0;

            // Calculate individual balances
            expenses.forEach(expense => {
                totalExpenses += expense.amount;
                
                // Person who paid gets positive balance
                if (!balances[expense.paid_by]) {
                    balances[expense.paid_by] = { paid: 0, owes: 0, name: expense.payer_name || 'Unknown' };
                }
                balances[expense.paid_by].paid += expense.amount;

                // Each person who participated owes their share
                if (expense.splits) {
                    Object.entries(expense.splits).forEach(([person, amount]) => {
                        if (!balances[person]) {
                            balances[person] = { paid: 0, owes: 0, name: person };
                        }
                        balances[person].owes += amount;

                        // Track direct debt (who owes the payer)
                        if (person !== expense.paid_by && amount > 0) {
                            directDebts.push({
                                from: person,
                                to: expense.paid_by,
                                amount: amount,
                                expense: expense.description
                            });
                        }
                    });
                }
            });

            // Calculate net balances
            const netBalances = {};
            Object.entries(balances).forEach(([person, data]) => {
                netBalances[person] = {
                    ...data,
                    net: data.paid - data.owes
                };
            });

            // Calculate optimized settlements
            const optimizedSettlements = optimizeSettlements(netBalances);

            return {
                balances: netBalances,
                directDebts: groupDirectDebts(directDebts),
                optimizedSettlements,
                totalExpenses,
                expenseCount: expenses.length
            };
        }

        function groupDirectDebts(directDebts) {
            const grouped = {};
            
            directDebts.forEach(debt => {
                const key = `${debt.from}->${debt.to}`;
                if (!grouped[key]) {
                    grouped[key] = {
                        from: debt.from,
                        to: debt.to,
                        total: 0,
                        expenses: []
                    };
                }
                grouped[key].total += debt.amount;
                grouped[key].expenses.push(debt.expense);
            });

            return Object.values(grouped);
        }

        function optimizeSettlements(balances) {
            const settlements = [];
            const debtors = [];
            const creditors = [];

            // Separate debtors and creditors
            Object.entries(balances).forEach(([person, data]) => {
                if (data.net < -0.01) { // Owes money
                    debtors.push({ person, amount: Math.abs(data.net), name: data.name });
                } else if (data.net > 0.01) { // Gets money
                    creditors.push({ person, amount: data.net, name: data.name });
                }
            });

            // Match debtors with creditors
            while (debtors.length > 0 && creditors.length > 0) {
                const debtor = debtors[0];
                const creditor = creditors[0];
                
                const settleAmount = Math.min(debtor.amount, creditor.amount);
                
                settlements.push({
                    from: debtor.person,
                    fromName: debtor.name,
                    to: creditor.person,
                    toName: creditor.name,
                    amount: settleAmount
                });

                debtor.amount -= settleAmount;
                creditor.amount -= settleAmount;

                if (debtor.amount < 0.01) debtors.shift();
                if (creditor.amount < 0.01) creditors.shift();
            }

            return settlements;
        }

        function updateDisplay() {
            // Update summary
            document.getElementById('totalExpenses').textContent = `$${settlementData.totalExpenses.toFixed(2)}`;
            document.getElementById('expenseCount').textContent = settlementData.expenseCount;
            document.getElementById('participantCount').textContent = Object.keys(settlementData.balances).length;

            // Update balances list
            const balancesList = document.getElementById('balancesList');
            balancesList.innerHTML = '';

            Object.entries(settlementData.balances).forEach(([person, data]) => {
                const item = document.createElement('div');
                item.className = 'balance-item';
                
                const netAmount = data.net;
                let amountClass = 'neutral';
                let amountText = '$0.00';
                
                if (netAmount > 0.01) {
                    amountClass = 'positive';
                    amountText = `+$${netAmount.toFixed(2)}`;
                } else if (netAmount < -0.01) {
                    amountClass = 'negative';
                    amountText = `-$${Math.abs(netAmount).toFixed(2)}`;
                }

                item.innerHTML = `
                    <div class="person-info">
                        <div class="person-avatar">${(data.name || person).charAt(0).toUpperCase()}</div>
                        <div class="person-name">${data.name || person}</div>
                    </div>
                    <div class="balance-amount ${amountClass}">${amountText}</div>
                `;
                
                balancesList.appendChild(item);
            });

            // Update optimized settlements
            const optimizedContainer = document.getElementById('optimizedSettlements');
            optimizedContainer.innerHTML = '';

            if (settlementData.optimizedSettlements.length === 0) {
                optimizedContainer.innerHTML = '<div class="info-box">üéâ Everyone is already settled up!</div>';
            } else {
                settlementData.optimizedSettlements.forEach(settlement => {
                    const item = document.createElement('div');
                    item.className = 'settlement-item optimized-debt';
                    
                    item.innerHTML = `
                        <div class="person-info">
                            <div class="person-avatar">${settlement.fromName.charAt(0).toUpperCase()}</div>
                            <div class="person-name">${settlement.fromName}</div>
                        </div>
                        <div class="settlement-arrow">‚Üí</div>
                        <div class="person-info">
                            <div class="person-avatar">${settlement.toName.charAt(0).toUpperCase()}</div>
                            <div class="person-name">${settlement.toName}</div>
                        </div>
                        <div class="settlement-amount">$${settlement.amount.toFixed(2)}</div>
                    `;
                    
                    optimizedContainer.appendChild(item);
                });
            }

            // Update direct settlements
            const directContainer = document.getElementById('directSettlements');
            directContainer.innerHTML = '';

            if (settlementData.directDebts.length === 0) {
                directContainer.innerHTML = '<div class="info-box">üéâ No direct debts!</div>';
            } else {
                settlementData.directDebts.forEach(debt => {
                    const item = document.createElement('div');
                    item.className = 'settlement-item direct-debt';
                    
                    item.innerHTML = `
                        <div class="person-info">
                            <div class="person-avatar">${debt.from.charAt(0).toUpperCase()}</div>
                            <div class="person-name">${debt.from}</div>
                        </div>
                        <div class="settlement-arrow">‚Üí</div>
                        <div class="person-info">
                            <div class="person-avatar">${debt.to.charAt(0).toUpperCase()}</div>
                            <div class="person-name">${debt.to}</div>
                        </div>
                        <div class="settlement-amount">$${debt.total.toFixed(2)}</div>
                    `;
                    
                    directContainer.appendChild(item);
                });
            }
        }

        async function loadExpenses() {
            try {
                // Wait for OfflineStorage to be ready
                if (!window.OfflineStorage) {
                    console.log('‚è≥ Waiting for OfflineStorage...');
                    setTimeout(loadExpenses, 100);
                    return;
                }

                const user = window.OfflineStorage.getUser();
                if (!user) {
                    console.log('‚ùå No user found');
                    showDemoData();
                    return;
                }

                // Get all expenses from OfflineStorage
                const expenses = window.OfflineStorage.getExpenses();
                console.log('üìä Loaded expenses for settlement:', expenses.length, expenses);
                
                if (expenses.length === 0) {
                    console.log('‚ÑπÔ∏è No expenses found, showing empty state');
                    settlementData = {
                        balances: {},
                        directDebts: [],
                        optimizedSettlements: [],
                        totalExpenses: 0,
                        expenseCount: 0
                    };
                    updateDisplay();
                    return;
                }
                
                // Transform expenses to settlement format
                const transformedExpenses = expenses.map(expense => ({
                    id: expense.id,
                    amount: expense.amount,
                    description: expense.description,
                    paid_by: 'You', // Current user is always the payer in our system
                    payer_name: 'You',
                    splits: expense.splits || {},
                    participants: expense.participants || ['You']
                }));
                
                console.log('üîÑ Transformed expenses:', transformedExpenses);
                
                // Calculate settlements
                settlementData = calculateSettlements(transformedExpenses);
                updateDisplay();
                
            } catch (error) {
                console.error('Error loading expenses:', error);
                // Show empty state instead of demo data
                settlementData = {
                    balances: {},
                    directDebts: [],
                    optimizedSettlements: [],
                    totalExpenses: 0,
                    expenseCount: 0
                };
                updateDisplay();
            }
        }

        function showDemoData() {
            const demoExpenses = [
                {
                    amount: 60,
                    description: 'Dinner',
                    paid_by: 'you',
                    payer_name: 'You',
                    splits: { 'you': 20, 'alice': 20, 'bob': 20 }
                },
                {
                    amount: 30,
                    description: 'Taxi',
                    paid_by: 'alice',
                    payer_name: 'Alice',
                    splits: { 'you': 15, 'alice': 15 }
                },
                {
                    amount: 45,
                    description: 'Lunch',
                    paid_by: 'bob',
                    payer_name: 'Bob',
                    splits: { 'you': 15, 'alice': 15, 'bob': 15 }
                }
            ];

            settlementData = calculateSettlements(demoExpenses);
            updateDisplay();
        }

        function shareSettlement() {
            const report = generateSettlementReport();
            
            if (navigator.share) {
                navigator.share({
                    title: 'Splitzee Settlement Report',
                    text: report
                });
            } else {
                // Fallback: copy to clipboard
                navigator.clipboard.writeText(report).then(() => {
                    alert('Settlement report copied to clipboard!');
                });
            }
        }

        function generateSettlementReport() {
            let report = `üí∞ SPLITZEE SETTLEMENT REPORT\n\n`;
            
            report += `üìä TRIP SUMMARY\n`;
            report += `Total Spent: $${settlementData.totalExpenses.toFixed(2)}\n`;
            report += `Expenses: ${settlementData.expenseCount}\n`;
            report += `People: ${Object.keys(settlementData.balances).length}\n\n`;

            report += `üí∞ INDIVIDUAL BALANCES\n`;
            Object.entries(settlementData.balances).forEach(([person, data]) => {
                const net = data.net;
                if (net > 0.01) {
                    report += `${data.name}: gets back $${net.toFixed(2)}\n`;
                } else if (net < -0.01) {
                    report += `${data.name}: owes $${Math.abs(net).toFixed(2)}\n`;
                } else {
                    report += `${data.name}: settled up\n`;
                }
            });

            if (settlementData.optimizedSettlements.length > 0) {
                report += `\n‚öñÔ∏è OPTIMIZED SETTLEMENTS\n`;
                settlementData.optimizedSettlements.forEach(settlement => {
                    report += `${settlement.fromName} pays ${settlement.toName}: $${settlement.amount.toFixed(2)}\n`;
                });
            } else {
                report += `\nüéâ Everyone is settled up!\n`;
            }

            report += `\nGenerated by Splitzee üíé`;
            return report;
        }

        function goBack() {
            window.location.href = 'production-app.html';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            await new Promise(resolve => setTimeout(resolve, 100));
            await loadExpenses();
        });
    </script>
</body>
</html>