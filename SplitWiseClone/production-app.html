<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Splitzee - Expense Splitting</title>
    
    <!-- Prevent caching to force fresh load -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <!-- PWA Meta Tags -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Splitzee">
    <meta name="theme-color" content="#6200EE">
    
    <!-- Icon -->
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDE4MCAxODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjE4MCIgaGVpZ2h0PSIxODAiIHJ4PSI0MCIgZmlsbD0iIzYyMDBFRSIvPjx0ZXh0IHg9IjkwIiB5PSIxMTAiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IndoaXRlIiBmb250LXNpemU9IjgwIiBmb250LWZhbWlseT0ic3lzdGVtLXVpIj7wn5KwPC90ZXh0Pjwvc3ZnPg==">
    
    <!-- Online-Only Storage System -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
    <script>
        // Test if Supabase loaded immediately
        console.log('üß™ Supabase loaded after CDN:', !!window.supabase);
        if (window.supabase) {
            console.log('‚úÖ Supabase CDN loaded successfully');
        } else {
            console.error('‚ùå Supabase CDN failed to load');
        }
    </script>
    <script src="js/supabase-config.js?v=23"></script>
    <script src="js/supabase-integration.js?v=23"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background: #ffffff;
            padding: 16px;
            color: #333;
            padding-top: env(safe-area-inset-top, 44px);
            padding-bottom: env(safe-area-inset-bottom, 34px);
            min-height: 100vh;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            background: linear-gradient(135deg, #6200EE, #3700B3);
            border-radius: 12px;
            margin-bottom: 20px;
            color: white;
            box-shadow: 0 4px 12px rgba(98, 0, 238, 0.3);
        }

        .header-left {
            display: flex;
            align-items: center;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 12px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .user-avatar:hover {
            transform: scale(1.05);
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .user-email {
            font-size: 12px;
            opacity: 0.8;
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        .header-button {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
        }

        .header-button:active {
            background: rgba(255,255,255,0.3);
        }

        .title {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .subtitle {
            font-size: 16px;
            opacity: 0.9;
        }

        .card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08), 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12), 0 2px 8px rgba(0, 0, 0, 0.1);
            background: rgba(255, 255, 255, 0.95);
        }
        
        .card:active {
            transform: scale(0.98);
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 16px;
        }

        .balance-card {
            text-align: center;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            position: relative;
            overflow: hidden;
        }
        
        .balance-card:hover {
            background: linear-gradient(135deg, #4CAF50, #45a049) !important;
            color: white !important;
        }
        
        .balance-card:hover .balance-amount,
        .balance-card:hover .balance-text,
        .balance-card:hover .balance-trend,
        .balance-card:hover .card-title {
            color: white !important;
        }

        .balance-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
            transform: rotate(45deg);
        }

        .balance-amount {
            font-size: 42px;
            font-weight: bold;
            margin-bottom: 8px;
            position: relative;
            z-index: 1;
            color: white !important;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .balance-text {
            font-size: 16px;
            opacity: 0.9;
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
            color: white !important;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        .balance-trend {
            font-size: 14px;
            margin-bottom: 16px;
            position: relative;
            z-index: 1;
            color: white !important;
            opacity: 0.9;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        .button {
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 14px 28px;
            border-radius: 25px;
            border: none;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            position: relative;
            z-index: 1;
        }

        .button:active {
            transform: scale(0.95);
            background: rgba(255,255,255,0.3);
        }

        .primary-button {
            background: #6200EE;
            color: white;
            width: 100%;
            border-radius: 12px;
            font-size: 18px;
            padding: 16px;
            box-shadow: 0 4px 12px rgba(98, 0, 238, 0.3);
        }

        .primary-button:active {
            background: #3700B3;
            transform: scale(0.98);
        }
        
        .settlement-button {
            background: #4CAF50;
            color: white;
            width: 100%;
            border-radius: 12px;
            font-size: 18px;
            padding: 16px;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
            margin-top: 12px;
        }
        
        .settlement-button:active {
            background: #45a049;
            transform: scale(0.98);
        }
        
        .premium-upgrade-button {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: white;
            width: 100%;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            padding: 16px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3);
            margin-top: 16px;
            display: block;
        }
        
        .premium-upgrade-button:active {
            background: linear-gradient(135deg, #FFA500, #FF8C00);
            transform: scale(0.98);
        }

        .group-item, .expense-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 8px;
            margin: 0 -8px;
            padding-left: 8px;
            color: #333;
            padding-right: 8px;
        }

        .group-item:hover, .expense-item:hover {
            background-color: #f8f9fa;
        }
        
        .group-item:active, .expense-item:active {
            background-color: #e9ecef;
            transform: scale(0.98);
        }

        .group-item:last-child, .expense-item:last-child {
            border-bottom: none;
        }

        .group-name {
            font-size: 17px;
            font-weight: 600;
            color: #333;
        }

        .group-amount {
            font-size: 17px;
            font-weight: 700;
            color: #6200EE;
        }

        .expense-description {
            font-size: 16px;
            font-weight: 500;
            color: #333;
        }

        .expense-group {
            font-size: 13px;
            color: #666;
            margin-top: 4px;
        }

        .expense-amount {
            font-size: 16px;
            font-weight: 600;
            color: #4CAF50;
        }

        .fab {
            position: fixed;
            bottom: 30px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #6200EE, #3700B3);
            border-radius: 30px;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(98, 0, 238, 0.4);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .fab:active {
            transform: scale(0.9);
            box-shadow: 0 4px 16px rgba(98, 0, 238, 0.6);
        }

        .notification {
            position: fixed;
            top: 60px;
            left: 20px;
            right: 20px;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 16px 20px;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 500;
            transform: translateY(-120px);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 2000;
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.3);
        }

        .notification.show {
            transform: translateY(0);
            opacity: 1;
        }

        .section-divider {
            height: 1px;
            background: linear-gradient(90deg, transparent, #e0e0e0, transparent);
            margin: 8px 0;
        }

        .group-icon {
            font-size: 20px;
            margin-right: 12px;
        }

        .expense-icon {
            width: 8px;
            height: 8px;
            background: #4CAF50;
            border-radius: 50%;
            margin-right: 12px;
            flex-shrink: 0;
            margin-top: 6px;
        }

        .balance-trend {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 4px;
        }

        @media (max-width: 400px) {
            body {
                padding: 12px;
            }
            
            .container {
                padding: 0;
            }
        }

        /* Add smooth scrolling */
        html {
            scroll-behavior: smooth;
        }

        /* Loading animation for interactions */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .pulse {
            animation: pulse 0.6s ease-in-out;
        }
    </style>
</head>
<body>
    <div class="notification" id="notification">
        Welcome to SplitWise! üéâ
    </div>

    <div class="container">
        <div class="header">
            <div class="header-left">
                <div class="user-avatar" onclick="openProfile()" id="userAvatar">üë§</div>
                <div class="user-info">
                    <div class="user-name" id="userName">Demo User</div>
                    <div class="user-email" id="userEmail">demo@splitwise.com</div>
                </div>
            </div>
            <div class="header-actions">
                <button class="header-button" onclick="openProfile()" title="Profile & Logout">‚öôÔ∏è</button>
            </div>
        </div>

        <!-- Balance Card -->
        <div class="card balance-card">
            <div class="card-title">Your Balance</div>
            <div class="balance-amount" id="balanceAmount">$0.00</div>
            <div class="balance-text" id="balanceText">All settled up</div>
            <div class="balance-trend" id="balanceTrend">üìä Calculating trend...</div>
            <button class="button" onclick="settleUp()">Settle Up</button>
        </div>

        <!-- Subscription Status (Free users only) -->
        <div class="card" id="subscriptionCard" style="display: none;">
            <div class="card-title">üìä Usage This Month</div>
            <div style="margin-bottom: 16px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span>Expenses</span>
                    <span id="expenseUsage">0/10</span>
                </div>
                <div style="background: #f0f0f0; border-radius: 8px; height: 8px; overflow: hidden;">
                    <div id="expenseProgress" style="background: linear-gradient(90deg, #4CAF50, #FF9800); height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                </div>
            </div>
            <div style="margin-bottom: 16px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span>Groups</span>
                    <span id="groupUsage">0/3</span>
                </div>
                <div style="background: #f0f0f0; border-radius: 8px; height: 8px; overflow: hidden;">
                    <div id="groupProgress" style="background: linear-gradient(90deg, #4CAF50, #FF9800); height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                </div>
            </div>
            <button class="button premium-upgrade-button" onclick="upgradeToPremium()">
                üíé Upgrade to Premium
            </button>
        </div>

        <!-- Quick Actions -->
        <div class="card">
            <div class="card-title">Quick Actions</div>
            <button class="button primary-button" onclick="addExpense()" id="addExpenseButton">
                ‚ûï Add Expense
            </button>
            <button class="button settlement-button" onclick="openSettlement()">
                ‚öñÔ∏è Settlement Calculator
            </button>
        </div>

        <!-- Groups/Friends -->
        <div class="card" id="groupsCard">
            <div class="card-title">Your Friends</div>
            <div style="text-align: center; padding: 20px; color: #666;">
                <div style="font-size: 48px; margin-bottom: 12px;">üë•</div>
                <div>Loading friends...</div>
            </div>
        </div>

        <!-- Recent Expenses -->
        <div class="card" id="recentExpensesCard">
            <div class="card-title">Recent Expenses</div>
            <div style="text-align: center; padding: 20px; color: #666;">
                <div style="font-size: 48px; margin-bottom: 12px;">üí∞</div>
                <div>Loading expenses...</div>
            </div>
        </div>

        <!-- Summary Card -->
        <div class="card">
            <div class="card-title">This Month</div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <div style="font-size: 14px; color: #666;">Total Expenses</div>
                    <div id="totalExpensesAmount" style="font-size: 24px; font-weight: bold; color: #333;">$0.00</div>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 14px; color: #666;">Your Share</div>
                    <div id="yourShareAmount" style="font-size: 24px; font-weight: bold; color: #6200EE;">$0.00</div>
                </div>
            </div>
        </div>
    </div>

    <button class="fab" onclick="addExpense()" title="Add Expense">+</button>

    <script>
        // Global safeguard to prevent redirects to login.html
        // Override window.location.replace
        const originalReplace = window.location.replace;
        window.location.replace = function(url) {
            if (url && url.includes('login.html')) {
                console.warn('üö´ Blocked location.replace to login.html:', url);
                console.trace('Replace attempt stack trace:');
                return; // Block the redirect completely
            }
            originalReplace.call(this, url);
        };

        // Override window.location.assign
        const originalAssign = window.location.assign;
        window.location.assign = function(url) {
            if (url && url.includes('login.html')) {
                console.warn('üö´ Blocked location.assign to login.html:', url);
                console.trace('Assign attempt stack trace:');
                return; // Block the redirect completely
            }
            originalAssign.call(this, url);
        };

        // Intercept programmatic navigation attempts
        const originalPushState = history.pushState;
        history.pushState = function(state, title, url) {
            if (url && url.includes('login.html')) {
                console.warn('üö´ Blocked pushState to login.html:', url);
                console.trace('PushState attempt stack trace:');
                return; // Block the redirect completely
            }
            originalPushState.call(this, state, title, url);
        };

        // Monitor for any unintended navigation to login.html
        window.addEventListener('beforeunload', function(event) {
            const currentUrl = window.location.href;
            if (currentUrl.includes('login.html')) {
                console.warn('üö´ Detected navigation to login.html, attempting to stay on page');
                event.preventDefault();
                event.returnValue = 'Prevented navigation to login.html';
                window.location.href = 'production-app.html';
                return 'Prevented navigation to login.html';
            }
        });

        // Authentication is now handled in loadUserSession()

        // Clean up any old problematic storage items
        try {
            const keysToRemove = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.includes('login') && !key.includes('splitwise_session')) {
                    keysToRemove.push(key);
                }
            }
            keysToRemove.forEach(key => localStorage.removeItem(key));
        } catch (error) {
            console.warn('Error cleaning storage:', error);
        }

        let currentBalance = 0;
        let currentUser = null;

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            
            // Change color based on type
            if (type === 'success') {
                notification.style.background = 'linear-gradient(135deg, #4CAF50, #45a049)';
            } else if (type === 'info') {
                notification.style.background = 'linear-gradient(135deg, #2196F3, #1976D2)';
            } else if (type === 'warning') {
                notification.style.background = 'linear-gradient(135deg, #FF9800, #F57C00)';
            }
            
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function updateBalance(newBalance) {
            currentBalance = newBalance;
            const balanceElement = document.getElementById('balanceAmount');
            const textElement = document.getElementById('balanceText');
            
            // Add pulse animation
            balanceElement.classList.add('pulse');
            setTimeout(() => balanceElement.classList.remove('pulse'), 600);
            
            balanceElement.textContent = `$${Math.abs(currentBalance).toFixed(2)}`;
            
            if (currentBalance > 0) {
                textElement.textContent = `You are owed $${currentBalance.toFixed(2)}`;
                balanceElement.style.color = 'white';
                // Update card background to positive color
                balanceElement.closest('.balance-card').style.background = 'linear-gradient(135deg, #4CAF50, #45a049)';
            } else if (currentBalance < 0) {
                textElement.textContent = `You owe $${Math.abs(currentBalance).toFixed(2)}`;
                balanceElement.style.color = 'white';
                // Update card background to negative color
                balanceElement.closest('.balance-card').style.background = 'linear-gradient(135deg, #F44336, #d32f2f)';
            } else {
                textElement.textContent = 'You are all settled up!';
                balanceElement.style.color = 'white';
                // Update card background to neutral color
                balanceElement.closest('.balance-card').style.background = 'linear-gradient(135deg, #4CAF50, #45a049)';
            }
            
            // Update weekly trend dynamically
            updateWeeklyTrend();
        }

        function updateWeeklyTrend() {
            try {
                const expenses = window.SupabaseSync.getExpenses();
                const weekAgo = new Date();
                weekAgo.setDate(weekAgo.getDate() - 7);
                
                // Calculate this week's activity
                let weeklyChange = 0;
                let weeklyTransactions = 0;
                
                Object.values(expenses).forEach(expense => {
                    const expenseDate = new Date(expense.date || expense.created);
                    if (expenseDate >= weekAgo) {
                        weeklyTransactions++;
                        // Calculate your share of the expense
                        const splits = expense.splits || {};
                        const yourShare = splits[currentUser?.name] || splits['You'] || 0;
                        weeklyChange += yourShare || 0;
                    }
                });
                
                // Update the trend display
                const trendElement = document.querySelector('.balance-trend');
                if (trendElement) {
                    if (weeklyTransactions === 0) {
                        trendElement.innerHTML = 'üìä No activity this week';
                        trendElement.style.color = '#666';
                    } else {
                        const changeText = Math.abs(weeklyChange).toFixed(2);
                        let icon, sign, color;
                        
                        if (weeklyChange > 0) {
                            icon = '‚ÜóÔ∏è';
                            sign = '+';
                            color = '#4CAF50';
                        } else if (weeklyChange < 0) {
                            icon = '‚ÜòÔ∏è'; 
                            sign = '-';
                            color = '#F44336';
                        } else {
                            icon = '‚û°Ô∏è';
                            sign = '';
                            color = '#666';
                        }
                        
                        trendElement.innerHTML = `${icon} ${sign}$${changeText} this week (${weeklyTransactions} transactions)`;
                        trendElement.style.color = color;
                    }
                }
            } catch (error) {
                console.error('Error updating weekly trend:', error);
                // Fallback to neutral message
                const trendElement = document.querySelector('.balance-trend');
                if (trendElement) {
                    trendElement.innerHTML = 'üìä Calculating trend...';
                    trendElement.style.color = '#666';
                }
            }
        }

        function addExpense() {
            console.log('üîÑ addExpense() called');
            
            try {
                // Check if user can create expense
                const stats = window.SupabaseSync.getUsageStats();
                console.log('üìä Usage stats:', stats);
                console.log('üë§ Current user:', currentUser);
                
                if (!currentUser.isPremium && stats.expensesThisMonth >= 5) {
                    console.log('‚ùå User hit expense limit, redirecting to premium');
                    showNotification('You\'ve reached the monthly limit of 5 expenses. Upgrade to Premium for unlimited expenses! üíé', 'warning');
                    setTimeout(() => {
                        console.log('üîÑ Redirecting to premium.html');
                        window.location.href = 'premium.html';
                    }, 2000);
                    return;
                }
                
                // Clear any existing edit data and drafts before navigating to expense form
                localStorage.removeItem('splitzee_edit_expense_id');
                localStorage.removeItem('splitzee_draft');
                
                // Add a timestamp to force fresh load
                const newUrl = 'expense-form-new.html?new=' + Date.now();
                console.log('‚úÖ Redirecting to expense form:', newUrl);
                window.location.href = newUrl;
                
            } catch (error) {
                console.error('‚ùå Error in addExpense():', error);
                showNotification('Error opening expense form. Please try again.', 'error');
            }
        }

        function upgradeToPremium() {
            window.location.href = 'premium.html?v=' + Date.now();
        }

        function openSettlement() {
            window.location.href = 'settlement-calculator.html';
        }

        function openProfile() {
            // Directly show the enhanced profile modal
            showProfileInfo();
        }

        function showProfileInfo() {
            const user = currentUser;
            const stats = window.SupabaseSync.getUsageStats();
            const friends = window.SupabaseSync.getFriends();
            const expenses = window.SupabaseSync.getExpenses();
            
            // Create a modal overlay
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white;
                border-radius: 16px;
                padding: 32px;
                max-width: 400px;
                width: 90%;
                max-height: 80vh;
                overflow-y: auto;
                box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            `;
            
            // Calculate advanced statistics
            const totalExpenseAmount = Object.values(expenses).reduce((sum, exp) => sum + (exp.amount || 0), 0);
            const avgExpenseAmount = Object.keys(expenses).length > 0 ? totalExpenseAmount / Object.keys(expenses).length : 0;
            const recentExpenses = Object.values(expenses).filter(exp => {
                const expDate = new Date(exp.date || exp.created);
                const weekAgo = new Date();
                weekAgo.setDate(weekAgo.getDate() - 7);
                return expDate >= weekAgo;
            }).length;
            
            content.innerHTML = `
                <div style="text-align: center; margin-bottom: 24px;">
                    <div style="width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(135deg, #6200EE, #3700B3); margin: 0 auto 16px; display: flex; align-items: center; justify-content: center; font-size: 32px; color: white;">
                        ${user.avatar || 'üë§'}
                    </div>
                    <h2 style="margin: 0; color: #333; font-size: 24px;">${user.name}</h2>
                    <div style="margin-top: 8px; padding: 4px 12px; background: ${user.isPremium ? 'linear-gradient(135deg, #FFD700, #FFA500)' : '#f0f0f0'}; border-radius: 16px; display: inline-block; font-size: 12px; font-weight: 600; color: ${user.isPremium ? '#333' : '#666'};">
                        ${user.isPremium ? 'üíé PREMIUM MEMBER' : 'üÜì FREE ACCOUNT'}
                    </div>
                </div>
                
                <div style="margin-bottom: 24px;">
                    <h3 style="color: #6200EE; margin-bottom: 12px; font-size: 18px;">üë§ Personal Details</h3>
                    <div style="border: 1px solid #e0e0e0; border-radius: 8px; overflow: hidden;">
                        <div style="padding: 12px 16px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between;">
                            <span style="color: #666;">Email</span>
                            <span style="font-weight: 500; color: #333;">${user.email}</span>
                        </div>
                        <div style="padding: 12px 16px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between;">
                            <span style="color: #666;">Member Since</span>
                            <span style="font-weight: 500; color: #333;">${new Date(user.createdAt).toLocaleDateString()}</span>
                        </div>
                        <div style="padding: 12px 16px; display: flex; justify-content: space-between;">
                            <span style="color: #666;">Account Type</span>
                            <span style="font-weight: 500; color: #333;">${user.isPremium ? 'Premium' : 'Free'}</span>
                        </div>
                    </div>
                </div>
                
                <div style="margin-bottom: 24px;">
                    <h3 style="color: #6200EE; margin-bottom: 12px; font-size: 18px;">üìä Activity Overview</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                        <div style="background: #f8f9ff; border: 1px solid #e8ebff; border-radius: 8px; padding: 16px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #6200EE;">${Object.keys(expenses).length}</div>
                            <div style="font-size: 12px; color: #666; margin-top: 4px;">Total Expenses</div>
                        </div>
                        <div style="background: #f0fdf4; border: 1px solid #dcfce7; border-radius: 8px; padding: 16px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #16a34a;">${friends.length}</div>
                            <div style="font-size: 12px; color: #666; margin-top: 4px;">Friends Added</div>
                        </div>
                        <div style="background: #fefce8; border: 1px solid #fef3c7; border-radius: 8px; padding: 16px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #d97706;">$${totalExpenseAmount.toFixed(0)}</div>
                            <div style="font-size: 12px; color: #666; margin-top: 4px;">Total Amount</div>
                        </div>
                        <div style="background: #f3e8ff; border: 1px solid #e9d5ff; border-radius: 8px; padding: 16px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #9333ea;">${recentExpenses}</div>
                            <div style="font-size: 12px; color: #666; margin-top: 4px;">This Week</div>
                        </div>
                    </div>
                    <div style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 12px; background: #fafafa;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: #666;">Average Expense:</span>
                            <span style="font-weight: 500; color: #333;">$${avgExpenseAmount.toFixed(2)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: #666;">Account Status:</span>
                            <span style="font-weight: 500; color: ${user.isPremium ? '#16a34a' : '#d97706'};">${user.isPremium ? 'Premium Active' : 'Free Tier'}</span>
                        </div>
                    </div>
                </div>
                
                <div style="margin-bottom: 24px;">
                    <h3 style="color: #6200EE; margin-bottom: 12px; font-size: 18px;">‚ö° Quick Actions</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                        <button onclick="exportUserData(); this.closest('.profile-modal').remove();" style="padding: 10px; border: 1px solid #6200EE; background: white; color: #6200EE; border-radius: 6px; cursor: pointer; font-size: 14px;">üìÅ Export Data</button>
                        <button onclick="showSettings(); this.closest('.profile-modal').remove();" style="padding: 10px; border: 1px solid #6200EE; background: white; color: #6200EE; border-radius: 6px; cursor: pointer; font-size: 14px;">‚öôÔ∏è Settings</button>
                        <button onclick="window.open('premium.html', '_blank')" style="padding: 10px; border: 1px solid #d97706; background: white; color: #d97706; border-radius: 6px; cursor: pointer; font-size: 14px;">üíé Upgrade</button>
                        <button onclick="confirmLogout(); this.closest('.profile-modal').remove();" style="padding: 10px; border: 1px solid #dc2626; background: white; color: #dc2626; border-radius: 6px; cursor: pointer; font-size: 14px;">üö™ Logout</button>
                    </div>
                </div>
                
                <button onclick="this.closest('.profile-modal').remove()" style="
                    background: linear-gradient(135deg, #6200EE, #3700B3);
                    color: white;
                    border: none;
                    padding: 12px 24px;
                    border-radius: 8px;
                    font-size: 16px;
                    font-weight: 600;
                    cursor: pointer;
                    width: 100%;
                ">Close Profile</button>
            `;
            
            modal.className = 'profile-modal';
            modal.appendChild(content);
            
            // Close modal when clicking outside
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
            
            document.body.appendChild(modal);
        }

        function showSettings() {
            // Create a modal overlay for settings
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white;
                border-radius: 16px;
                padding: 32px;
                max-width: 450px;
                width: 90%;
                max-height: 80vh;
                overflow-y: auto;
                box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            `;
            
            content.innerHTML = `
                <div style="text-align: center; margin-bottom: 24px;">
                    <h2 style="margin: 0; color: #333; font-size: 24px;">‚öôÔ∏è Settings & Preferences</h2>
                </div>
                
                <div style="margin-bottom: 24px;">
                    <h3 style="color: #6200EE; margin-bottom: 12px; font-size: 18px;">üë§ Account Settings</h3>
                    <div style="border: 1px solid #e0e0e0; border-radius: 8px; overflow: hidden;">
                        <div class="setting-item" onclick="changeDisplayName()" style="padding: 12px 16px; cursor: pointer; border-bottom: 1px solid #e0e0e0; transition: background 0.2s;" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='white'">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <div>
                                    <div style="font-weight: 500; color: #333;">Display Name</div>
                                    <div style="font-size: 14px; color: #666;">Currently: ${currentUser.name}</div>
                                </div>
                                <div style="color: #6200EE;">‚úèÔ∏è</div>
                            </div>
                        </div>
                        <div class="setting-item" onclick="exportUserData()" style="padding: 12px 16px; cursor: pointer; border-bottom: 1px solid #e0e0e0; transition: background 0.2s;" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='white'">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <div>
                                    <div style="font-weight: 500; color: #333;">Export Data</div>
                                    <div style="font-size: 14px; color: #666;">Download all your data as JSON</div>
                                </div>
                                <div style="color: #6200EE;">üìÅ</div>
                            </div>
                        </div>
                        <div class="setting-item" onclick="clearAllData()" style="padding: 12px 16px; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='white'">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <div>
                                    <div style="font-weight: 500; color: #d32f2f;">Clear All Data</div>
                                    <div style="font-size: 14px; color: #666;">Delete all expenses and friends</div>
                                </div>
                                <div style="color: #d32f2f;">üóëÔ∏è</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-bottom: 24px;">
                    <h3 style="color: #6200EE; margin-bottom: 12px; font-size: 18px;">üîî Notifications</h3>
                    <div style="border: 1px solid #e0e0e0; border-radius: 8px; overflow: hidden;">
                        <div class="setting-item" style="padding: 12px 16px; border-bottom: 1px solid #e0e0e0;">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <div>
                                    <div style="font-weight: 500; color: #333;">Push Notifications</div>
                                    <div style="font-size: 14px; color: #666;">Get notified of new expenses</div>
                                </div>
                                <label style="position: relative; display: inline-block; width: 44px; height: 24px;">
                                    <input type="checkbox" id="pushNotifications" checked style="opacity: 0; width: 0; height: 0;">
                                    <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #6200EE; transition: .4s; border-radius: 24px; before: position: absolute; content: ''; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%;"></span>
                                </label>
                            </div>
                        </div>
                        <div class="setting-item" style="padding: 12px 16px;">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <div>
                                    <div style="font-weight: 500; color: #333;">Email Summaries</div>
                                    <div style="font-size: 14px; color: #666;">Weekly expense summaries</div>
                                </div>
                                <label style="position: relative; display: inline-block; width: 44px; height: 24px;">
                                    <input type="checkbox" id="emailSummaries" style="opacity: 0; width: 0; height: 0;">
                                    <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px;"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-bottom: 24px;">
                    <h3 style="color: #6200EE; margin-bottom: 12px; font-size: 18px;">üé® Appearance</h3>
                    <div style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px;">
                        <div style="margin-bottom: 12px;">
                            <div style="font-weight: 500; color: #333; margin-bottom: 8px;">Theme</div>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="setTheme('light')" style="flex: 1; padding: 8px 12px; border: 2px solid #6200EE; background: white; color: #6200EE; border-radius: 6px; cursor: pointer;">‚òÄÔ∏è Light</button>
                                <button onclick="setTheme('dark')" style="flex: 1; padding: 8px 12px; border: 2px solid #e0e0e0; background: white; color: #666; border-radius: 6px; cursor: pointer;">üåô Dark</button>
                                <button onclick="setTheme('auto')" style="flex: 1; padding: 8px 12px; border: 2px solid #e0e0e0; background: white; color: #666; border-radius: 6px; cursor: pointer;">üîÑ Auto</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="text-align: center; margin-bottom: 24px;">
                    <button onclick="this.closest('.settings-modal').remove()" style="
                        background: linear-gradient(135deg, #6200EE, #3700B3);
                        color: white;
                        border: none;
                        padding: 12px 24px;
                        border-radius: 8px;
                        font-size: 16px;
                        font-weight: 600;
                        cursor: pointer;
                        width: 100%;
                        margin-bottom: 12px;
                    ">Save & Close</button>
                    <div style="font-size: 12px; color: #666;">Settings are automatically saved</div>
                </div>
            `;
            
            modal.className = 'settings-modal';
            modal.appendChild(content);
            
            // Close modal when clicking outside
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
            
            document.body.appendChild(modal);
        }

        function exportUserData() {
            try {
                const userData = {
                    user: currentUser,
                    expenses: window.SupabaseSync.getExpenses(),
                    friends: window.SupabaseSync.getFriends(),
                    groups: window.SupabaseSync.getGroups(),
                    exportDate: new Date().toISOString()
                };
                
                const dataStr = JSON.stringify(userData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `splitzee-data-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                URL.revokeObjectURL(url);
                showNotification('Data exported successfully! üìÅ', 'success');
            } catch (error) {
                console.error('Export error:', error);
                showNotification('Failed to export data: ' + error.message, 'error');
            }
        }

        function changeDisplayName() {
            const newName = prompt('Enter new display name:', currentUser.name);
            if (newName && newName.trim() && newName !== currentUser.name) {
                currentUser.name = newName.trim();
                localStorage.setItem('splitwise_session', JSON.stringify(currentUser));
                showNotification('Display name updated successfully! ‚ú®', 'success');
                
                // Update UI
                document.getElementById('userNameHeader').textContent = currentUser.name;
                document.getElementById('userAvatar').title = currentUser.name;
                
                // Close settings modal and refresh
                document.querySelector('.settings-modal')?.remove();
            }
        }

        function clearAllData() {
            const confirmed = confirm('‚ö†Ô∏è This will delete ALL your data including expenses, friends, and groups. This action cannot be undone. Are you sure?');
            if (confirmed) {
                const doubleConfirm = confirm('This is your final warning. ALL DATA WILL BE LOST. Continue?');
                if (doubleConfirm) {
                    // Clear all local storage data
                    const keysToRemove = [];
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key && (key.startsWith('splitzee_') || key.startsWith('splitwise_'))) {
                            keysToRemove.push(key);
                        }
                    }
                    keysToRemove.forEach(key => localStorage.removeItem(key));
                    
                    // Reset to initial state
                    window.SupabaseSync.clearAllData();
                    
                    showNotification('All data has been cleared. Refreshing app...', 'info');
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                }
            }
        }

        function setTheme(theme) {
            localStorage.setItem('splitzee_theme', theme);
            showNotification(`Theme set to ${theme} mode! üé®`, 'success');
            
            // Update theme buttons visual state
            document.querySelectorAll('[onclick^="setTheme"]').forEach(btn => {
                if (btn.onclick.toString().includes(`'${theme}'`)) {
                    btn.style.borderColor = '#6200EE';
                    btn.style.color = '#6200EE';
                } else {
                    btn.style.borderColor = '#e0e0e0';
                    btn.style.color = '#666';
                }
            });
            
            // Apply theme immediately (basic implementation)
            if (theme === 'dark') {
                document.body.style.background = '#1a1a1a';
                document.body.style.color = '#fff';
            } else {
                document.body.style.background = '#ffffff';
                document.body.style.color = '#333';
            }
        }

        function logout() {
            // Show logout confirmation with better UX
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white;
                border-radius: 16px;
                padding: 32px;
                max-width: 350px;
                width: 90%;
                text-align: center;
                box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            `;
            
            content.innerHTML = `
                <div style="font-size: 48px; margin-bottom: 16px;">üëã</div>
                <h3 style="margin: 0 0 16px 0; color: #333; font-size: 20px;">Sign Out</h3>
                <p style="margin: 0 0 24px 0; color: #666; line-height: 1.4;">Are you sure you want to sign out? Your data will be saved and you can sign back in anytime.</p>
                
                <div style="display: flex; gap: 12px;">
                    <button onclick="this.closest('div').parentElement.remove()" style="
                        flex: 1;
                        padding: 12px 16px;
                        border: 2px solid #e0e0e0;
                        background: white;
                        color: #666;
                        border-radius: 8px;
                        font-size: 16px;
                        font-weight: 500;
                        cursor: pointer;
                    ">Cancel</button>
                    <button onclick="confirmLogout()" style="
                        flex: 1;
                        padding: 12px 16px;
                        border: none;
                        background: linear-gradient(135deg, #dc2626, #b91c1c);
                        color: white;
                        border-radius: 8px;
                        font-size: 16px;
                        font-weight: 600;
                        cursor: pointer;
                    ">Sign Out</button>
                </div>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
            
            // Close modal when clicking outside
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        function confirmLogout() {
            // Close any modals
            document.querySelectorAll('[style*="position: fixed"]').forEach(modal => modal.remove());
            
            // Show logout progress
            const progressModal = document.createElement('div');
            progressModal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10001;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            `;
            
            progressModal.innerHTML = `
                <div style="background: white; border-radius: 16px; padding: 40px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.3);">
                    <div style="font-size: 40px; margin-bottom: 16px;">üö™</div>
                    <h3 style="margin: 0 0 12px 0; color: #333;">Signing out...</h3>
                    <p style="margin: 0; color: #666; font-size: 14px;">Saving your session data</p>
                    <div style="width: 200px; height: 4px; background: #f0f0f0; border-radius: 2px; margin: 20px auto; overflow: hidden;">
                        <div style="width: 0%; height: 100%; background: linear-gradient(135deg, #6200EE, #3700B3); border-radius: 2px; transition: width 2s ease;" id="logoutProgress"></div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(progressModal);
            
            // Animate progress bar
            setTimeout(() => {
                document.getElementById('logoutProgress').style.width = '100%';
            }, 100);
            
            // Clear session data
            localStorage.removeItem('splitwise_session');
            
            // Clear all local storage data (but keep theme preferences)
            const keysToRemove = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('splitzee_') && key !== 'splitzee_theme') {
                    keysToRemove.push(key);
                }
            }
            keysToRemove.forEach(key => localStorage.removeItem(key));
            
            // Redirect after animation
            setTimeout(() => {
                window.location.href = 'login.html';
            }, 2500);
        }

        function openUsers() {
            window.location.href = 'production-app.html';
        }

        async function loadUserSession() {
            try {
                // Check authentication
                const session = localStorage.getItem('splitwise_session');
                
                if (!session) {
                    console.log('No session found, redirecting to login');
                    window.location.href = 'login.html';
                    return;
                }
                
                let authenticatedUser;
                try {
                    const sessionData = JSON.parse(session);
                    const expiresAt = new Date(sessionData.expiresAt);
                    const now = new Date();
                    
                    if (expiresAt <= now) {
                        console.log('Session expired, redirecting to login');
                        localStorage.removeItem('splitwise_session');
                        window.location.href = 'login.html';
                        return;
                    }
                    
                    authenticatedUser = sessionData.user;
                } catch (error) {
                    console.error('Invalid session data:', error);
                    localStorage.removeItem('splitwise_session');
                    window.location.href = 'login.html';
                    return;
                }
                
                // Get or initialize user in OfflineStorage
                let user = window.SupabaseSync.getUser();
                
                if (!user || !user.id) {
                    window.SupabaseSync.updateUser(authenticatedUser);
                    user = window.SupabaseSync.getUser();
                }
                
                currentUser = user;
                
                // Initialize Supabase user for real-time sync
                console.log('üîÑ Initializing Supabase authentication...');
                await window.SupabaseSync.initializeUser();
                
                // Update header with user info
                document.getElementById('userName').textContent = currentUser.name;
                document.getElementById('userEmail').textContent = currentUser.email;
                
                // Update avatar
                const avatarElement = document.getElementById('userAvatar');
                if (currentUser.avatar && currentUser.avatar.includes('http')) {
                    avatarElement.innerHTML = `<img src="${currentUser.avatar}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;" alt="Profile">`;
                } else {
                    const initials = currentUser.name.split(' ').map(n => n[0]).join('').toUpperCase();
                    avatarElement.textContent = initials;
                }
                
                return true;
            } catch (error) {
                console.error('Error loading session:', error);
                return false;
            }
        }

        async function initializeApp() {
            await loadUserSession();
            
            // Load friends from Supabase (if available) and merge with local
            await window.SupabaseSync.loadFriendsFromSupabase();
            
            // Load usage stats and show subscription card for free users
            await loadUsageStats();
            
            // Load and display actual expenses
            await loadExpenseData();
            
            // Show welcome message for new sessions
            const isNewSession = !sessionStorage.getItem('app_initialized');
            if (isNewSession) {
                sessionStorage.setItem('app_initialized', 'true');
                const tier = currentUser.isPremium ? 'üíé Premium' : 'üÜì Free';
                showNotification(`‚úÖ ${tier} | Welcome back, ${currentUser.name}! üëã`);
            }
        }

        async function loadUsageStats() {
            try {
                const stats = window.SupabaseSync.getUsageStats();
                
                // Show subscription card only for free users
                if (!currentUser.isPremium) {
                    document.getElementById('subscriptionCard').style.display = 'block';
                    
                    // Update expense usage (handle undefined values)
                    const expensesUsed = stats.expensesThisMonth || 0;
                    const groupsUsed = stats.groupsThisMonth || 0;
                    
                    console.log('üìä Usage Stats Debug:', {
                        stats: stats,
                        expensesUsed: expensesUsed,
                        groupsUsed: groupsUsed,
                        isPremium: currentUser.isPremium
                    });
                    
                    document.getElementById('expenseUsage').textContent = `${expensesUsed}/5`;
                    const expensePercent = (expensesUsed / 5) * 100;
                    document.getElementById('expenseProgress').style.width = `${Math.min(expensePercent, 100)}%`;
                    
                    // Update group usage
                    document.getElementById('groupUsage').textContent = `${groupsUsed}/3`;
                    const groupPercent = (groupsUsed / 3) * 100;
                    document.getElementById('groupProgress').style.width = `${Math.min(groupPercent, 100)}%`;
                    
                    // Note: Removed automatic limit warnings - these should only show when user tries to add expense/group
                }
                
            } catch (error) {
                console.error('Error loading usage stats:', error);
            }
        }

        async function loadExpenseData() {
            try {
                const expenses = window.SupabaseSync.getExpenses();
                const recentExpenses = expenses.slice(-3).reverse(); // Get last 3 expenses, newest first
                
                // Debug: Log expense data to understand structure
                console.log('üìä Debug - Expenses found:', expenses.length);
                if (expenses.length > 0) {
                    expenses.forEach((expense, i) => {
                        console.log(`Expense ${i}:`, {
                            id: expense.id,
                            description: expense.description,
                            amount: expense.amount,
                            splits: expense.splits,
                            participants: expense.participants
                        });
                    });
                }
                console.log('üßë Current user:', currentUser);
                
                // Calculate totals - Force reset if no expenses
                const totalAmount = expenses.length > 0 ? expenses.reduce((sum, expense) => sum + expense.amount, 0) : 0;
                let userShare = 0; // Start with 0
                
                if (expenses.length > 0) {
                    userShare = expenses.reduce((sum, expense) => {
                    // Try multiple ways to find user's share
                    let userSplit = 0;
                    if (expense.splits) {
                        // Check all possible keys for user's share
                        const possibleKeys = [
                            'You',
                            currentUser.name,
                            currentUser.id,
                            'Me',
                            currentUser.name?.toLowerCase(),
                            currentUser.name?.toUpperCase()
                        ];
                        
                        for (const key of possibleKeys) {
                            if (key && expense.splits[key] !== undefined) {
                                userSplit = expense.splits[key];
                                break;
                            }
                        }
                        
                        // If still no match, check if this is creator's expense and split equally
                        if (userSplit === 0 && expense.createdBy === currentUser.id && expense.participants) {
                            userSplit = expense.amount / expense.participants.length;
                        }
                        
                        // Debug log for each expense
                        console.log(`üí∞ Expense "${expense.description}": userSplit = ${userSplit}`, {
                            'You': expense.splits['You'],
                            [currentUser.name]: expense.splits[currentUser.name],
                            [currentUser.id]: expense.splits[currentUser.id],
                            allSplits: expense.splits,
                            createdBy: expense.createdBy,
                            currentUserId: currentUser.id,
                            participants: expense.participants
                        });
                    }
                        return sum + userSplit;
                    }, 0);
                } else {
                    console.log('üîÑ No expenses found - userShare set to 0');
                }
                
                console.log('üìà Totals calculated:', { totalAmount, userShare });
                
                // Update balance card
                currentBalance = userShare; // Your balance is what you're owed/owe
                updateBalance(currentBalance);
                
                // Also ensure weekly trend is updated on initial load
                updateWeeklyTrend();
                
                // Update summary card totals using specific IDs
                const totalExpenseDiv = document.getElementById('totalExpensesAmount');
                const yourShareDiv = document.getElementById('yourShareAmount');
                
                console.log('üí∞ Found total div by ID:', !!totalExpenseDiv, 'Found share div by ID:', !!yourShareDiv);
                
                if (totalExpenseDiv) {
                    totalExpenseDiv.textContent = `$${totalAmount.toFixed(2)}`;
                    console.log('‚úÖ Updated total to:', totalExpenseDiv.textContent);
                } else {
                    console.log('‚ùå Total expense div not found by ID');
                }
                
                if (yourShareDiv) {
                    yourShareDiv.textContent = `$${userShare.toFixed(2)}`;
                    console.log('‚úÖ Updated share to:', yourShareDiv.textContent);
                } else {
                    console.log('‚ùå Your share div not found by ID');
                }
                
                // Update recent expenses list  
                const expenseContainer = document.getElementById('recentExpensesCard');
                if (recentExpenses.length > 0) {
                    const expenseList = recentExpenses.map((expense, index) => {
                        const timeAgo = getTimeAgo(expense.createdAt);
                        let userAmount = 0;
                        
                        if (expense.splits) {
                            // Use same lookup logic as total calculation
                            const possibleKeys = [
                                'You',
                                currentUser.name,
                                currentUser.id,
                                'Me',
                                currentUser.name?.toLowerCase(),
                                currentUser.name?.toUpperCase()
                            ];
                            
                            for (const key of possibleKeys) {
                                if (key && expense.splits[key] !== undefined) {
                                    userAmount = expense.splits[key];
                                    break;
                                }
                            }
                            
                            // Fallback for creator's expense
                            if (userAmount === 0 && expense.createdBy === currentUser.id && expense.participants) {
                                userAmount = expense.amount / expense.participants.length;
                            }
                        }
                        
                        return `
                            <div class="expense-item" onclick="viewExpense('${expense.id}')">
                                <div style="display: flex; align-items: flex-start;">
                                    <div class="expense-icon"></div>
                                    <div>
                                        <div class="expense-description">${expense.description}</div>
                                        <div class="expense-group">${expense.category} ‚Ä¢ ${timeAgo}</div>
                                    </div>
                                </div>
                                <div class="expense-amount">$${userAmount.toFixed(2)}</div>
                            </div>
                            ${index < recentExpenses.length - 1 ? '<div class="section-divider"></div>' : ''}
                        `;
                    }).join('');
                    
                    expenseContainer.innerHTML = `
                        <div class="card-title">Recent Expenses</div>
                        ${expenseList}
                    `;
                } else {
                    // Show empty state for expenses
                    expenseContainer.innerHTML = `
                        <div class="card-title">Recent Expenses</div>
                        <div style="text-align: center; padding: 20px; color: #666;">
                            <div style="font-size: 48px; margin-bottom: 12px;">üìù</div>
                            <div>No expenses yet</div>
                            <div style="font-size: 14px; margin-top: 8px;">Add your first expense to get started!</div>
                            <button class="button" style="background: #6200EE; color: white; margin-top: 16px;" onclick="addExpense()">
                                ‚ûï Add First Expense
                            </button>
                        </div>
                    `;
                }
                
                // Load and display friends/group members
                await loadGroupMembers();
                
            } catch (error) {
                console.error('Error loading expense data:', error);
            }
        }
        
        function getTimeAgo(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;
            const minutes = Math.floor(diff / (1000 * 60));
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            
            if (minutes < 1) {
                return 'Just now';
            } else if (minutes < 60) {
                return `${minutes} minutes ago`;
            } else if (hours < 24) {
                return `${hours} hours ago`;
            } else {
                return `${days} days ago`;
            }
        }
        
        async function loadGroupMembers() {
            try {
                const friends = window.SupabaseSync.getFriends();
                
                // Update the groups section with actual friends
                const groupsCard = document.getElementById('groupsCard');
                if (friends.length > 0) {
                    const friendsList = friends.map(friend => {
                        return `
                            <div class="group-item" onclick="openFriendExpenses('${friend.id}')">
                                <div>
                                    <span class="group-icon">üë§</span>
                                    <span class="group-name">${friend.name}</span>
                                </div>
                                <div class="group-amount">Active</div>
                            </div>
                            <div class="section-divider"></div>
                        `;
                    }).join('');
                    
                    groupsCard.innerHTML = `
                        <div class="card-title">Your Friends</div>
                        ${friendsList}
                        <div class="group-item" onclick="addFriend()" style="opacity: 0.7;">
                            <div>
                                <span class="group-icon">‚ûï</span>
                                <span class="group-name">Add Friend</span>
                            </div>
                            <div class="group-amount">Tap</div>
                        </div>
                    `;
                } else {
                    groupsCard.innerHTML = `
                        <div class="card-title">Your Friends</div>
                        <div style="text-align: center; padding: 20px; color: #666;">
                            <div style="font-size: 48px; margin-bottom: 12px;">üë•</div>
                            <div>No friends added yet</div>
                            <div style="font-size: 14px; margin-top: 8px;">Add friends to split expenses together!</div>
                            <button class="button" style="background: #4CAF50; color: white; margin-top: 16px;" onclick="addFriend()">
                                ‚ûï Add Your First Friend
                            </button>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Error loading group members:', error);
            }
        }
        
        function openFriendExpenses(friendId) {
            try {
                const expenses = window.SupabaseSync.getExpenses();
                const friends = window.SupabaseSync.getFriends();
                const friend = friends.find(f => f.id === friendId);
                
                console.log('üîç Opening expenses for friend:', friendId);
                console.log('üë• All friends:', friends);
                console.log('üéØ Found friend:', friend);
                console.log('üí∞ All expenses:', expenses);
                
                if (!friend) {
                    showNotification('Friend not found', 'warning');
                    return;
                }
                
                // Find expenses that include this friend (check multiple possible names)
                const sharedExpenses = expenses.filter(expense => {
                    if (!expense.participants) return false;
                    
                    // Check if friend is included by name
                    if (expense.participants.includes(friend.name)) {
                        return true;
                    }
                    
                    // For backward compatibility: if expense has "Person 2" and you only have 1 friend, assume it's this friend
                    if (expense.participants.includes('Person 2')) {
                        const friends = window.SupabaseSync.getFriends();
                        if (friends.length === 1 && friends[0].id === friend.id) {
                            return true;
                        }
                    }
                    
                    // Check if friend has splits in this expense
                    return expense.splits && expense.splits[friend.name] !== undefined;
                });
                
                if (sharedExpenses.length === 0) {
                    showNotification(`No shared expenses with ${friend.name} yet`, 'info');
                    return;
                }
                
                // Show a popup or navigate to expense view
                let expensesList = sharedExpenses.map(expense => {
                    const userSplit = expense.splits?.[currentUser.name] || expense.splits?.['You'] || 0;
                    const friendSplit = expense.splits?.[friend.name] || 0;
                    const timeAgo = getTimeAgo(expense.createdAt);
                    
                    return `
                        <div style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 12px; margin: 8px 0;">
                            <div style="font-weight: 600; color: #333;">${expense.description}</div>
                            <div style="font-size: 14px; color: #666; margin: 4px 0;">${expense.category} ‚Ä¢ ${timeAgo}</div>
                            <div style="display: flex; justify-content: space-between; font-size: 14px;">
                                <div>Total: $${expense.amount.toFixed(2)}</div>
                                <div>Your share: $${userSplit.toFixed(2)}</div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Create a modal-like display
                const modalHTML = `
                    <div id="friendExpensesModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px;">
                        <div style="background: white; border-radius: 16px; max-width: 400px; width: 100%; max-height: 80vh; overflow-y: auto; padding: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                <h3 style="margin: 0; color: #333;">Expenses with ${friend.name}</h3>
                                <button onclick="closeFriendExpensesModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">√ó</button>
                            </div>
                            <div style="color: #666; margin-bottom: 16px;">${sharedExpenses.length} shared expense${sharedExpenses.length !== 1 ? 's' : ''}</div>
                            ${expensesList}
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                showNotification(`Found ${sharedExpenses.length} expenses with ${friend.name}`, 'success');
                
            } catch (error) {
                console.error('Error loading friend expenses:', error);
                showNotification('Failed to load friend expenses', 'warning');
            }
        }
        
        function closeFriendExpensesModal() {
            const modal = document.getElementById('friendExpensesModal');
            if (modal) {
                modal.remove();
            }
        }
        
        function addFriend() {
            // Show modern friend invitation modal
            showFriendInvitationModal();
        }

        function showFriendInvitationModal() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white;
                border-radius: 16px;
                padding: 32px;
                max-width: 450px;
                width: 90%;
                max-height: 80vh;
                overflow-y: auto;
                box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            `;
            
            content.innerHTML = `
                <div style="text-align: center; margin-bottom: 24px;">
                    <div style="font-size: 48px; margin-bottom: 16px;">ü§ù</div>
                    <h2 style="margin: 0; color: #333; font-size: 24px;">Add Friends</h2>
                    <p style="margin: 8px 0 0 0; color: #666;">Connect with real users for secure expense sharing</p>
                </div>
                
                <div style="margin-bottom: 24px;">
                    <h3 style="color: #6200EE; margin-bottom: 12px; font-size: 18px;">üì§ Invite a Friend</h3>
                    <div style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px; background: #f8f9ff;">
                        <p style="margin: 0 0 12px 0; color: #333; font-size: 14px;">Generate a unique code to share with your friend</p>
                        <button onclick="generateInviteCode()" style="
                            background: linear-gradient(135deg, #6200EE, #3700B3);
                            color: white;
                            border: none;
                            padding: 12px 24px;
                            border-radius: 8px;
                            font-size: 16px;
                            font-weight: 600;
                            cursor: pointer;
                            width: 100%;
                        " id="generateCodeBtn">üîó Generate Invite Code</button>
                        <div id="inviteCodeDisplay" style="display: none; margin-top: 16px; padding: 12px; background: #e8f5e8; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #2e7d32; margin-bottom: 8px;" id="inviteCodeText"></div>
                            <div style="font-size: 12px; color: #666; margin-bottom: 8px;">Share this code with your friend</div>
                            <button onclick="copyInviteCode()" style="background: #4caf50; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer;">üìã Copy Code</button>
                        </div>
                    </div>
                </div>
                
                <div style="margin-bottom: 24px;">
                    <h3 style="color: #6200EE; margin-bottom: 12px; font-size: 18px;">üì• Join a Friend</h3>
                    <div style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px;">
                        <p style="margin: 0 0 12px 0; color: #333; font-size: 14px;">Enter the invite code your friend shared with you</p>
                        <div style="display: flex; gap: 8px;">
                            <input type="text" placeholder="Enter 8-character code" maxlength="8" id="friendCodeInput" style="
                                flex: 1;
                                padding: 12px;
                                border: 2px solid #e0e0e0;
                                border-radius: 8px;
                                font-size: 16px;
                                text-transform: uppercase;
                                text-align: center;
                                font-weight: bold;
                                letter-spacing: 2px;
                            ">
                            <button onclick="addFriendByCode()" style="
                                background: linear-gradient(135deg, #4CAF50, #45a049);
                                color: white;
                                border: none;
                                padding: 12px 16px;
                                border-radius: 8px;
                                font-size: 16px;
                                font-weight: 600;
                                cursor: pointer;
                                white-space: nowrap;
                            ">‚úÖ Add Friend</button>
                        </div>
                        <div id="codeResultDisplay" style="margin-top: 12px; display: none;"></div>
                    </div>
                </div>
                
                <div style="text-align: center; margin-bottom: 16px;">
                    <div style="padding: 12px; background: #fff3cd; border-radius: 8px; margin-bottom: 16px;">
                        <div style="font-size: 14px; color: #856404;">
                            <strong>üîí Secure & Private</strong><br>
                            Only users with your invite code can connect with you
                        </div>
                    </div>
                    <button onclick="this.closest('div').parentElement.remove()" style="
                        background: #f5f5f5;
                        color: #666;
                        border: 1px solid #e0e0e0;
                        padding: 12px 24px;
                        border-radius: 8px;
                        font-size: 16px;
                        cursor: pointer;
                        width: 100%;
                    ">Close</button>
                </div>
            `;
            
            modal.appendChild(content);
            
            // Close modal when clicking outside
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
            
            document.body.appendChild(modal);
            
            // Auto-format the code input
            const codeInput = document.getElementById('friendCodeInput');
            codeInput.addEventListener('input', (e) => {
                e.target.value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
            });
        }

        async function generateInviteCode() {
            const btn = document.getElementById('generateCodeBtn');
            const display = document.getElementById('inviteCodeDisplay');
            const codeText = document.getElementById('inviteCodeText');
            
            try {
                btn.textContent = '‚è≥ Generating...';
                btn.disabled = true;
                
                const result = await window.SupabaseSync.generateFriendCode();
                
                codeText.textContent = result.code;
                display.style.display = 'block';
                btn.textContent = 'üîÑ Generate New Code';
                btn.disabled = false;
                
                // Store code for copying
                window.currentInviteCode = result.code;
                
                showNotification(`Invite code generated: ${result.code}`, 'success');
                
            } catch (error) {
                console.error('Error generating invite code:', error);
                showNotification('Failed to generate invite code: ' + error.message, 'error');
                btn.textContent = 'üîó Generate Invite Code';
                btn.disabled = false;
            }
        }

        function copyInviteCode() {
            if (window.currentInviteCode) {
                navigator.clipboard.writeText(window.currentInviteCode).then(() => {
                    showNotification('Invite code copied to clipboard! üìã', 'success');
                }).catch(() => {
                    // Fallback for older browsers
                    const textArea = document.createElement('textarea');
                    textArea.value = window.currentInviteCode;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showNotification('Invite code copied! üìã', 'success');
                });
            }
        }

        async function addFriendByCode() {
            const input = document.getElementById('friendCodeInput');
            const resultDisplay = document.getElementById('codeResultDisplay');
            const code = input.value.trim();
            
            if (!code || code.length !== 8) {
                showNotification('Please enter a valid 8-character code', 'warning');
                return;
            }
            
            try {
                resultDisplay.style.display = 'block';
                resultDisplay.innerHTML = '<div style="color: #666; font-size: 14px;">‚è≥ Adding friend...</div>';
                
                const result = await window.SupabaseSync.addFriendByCode(code);
                
                resultDisplay.innerHTML = `
                    <div style="padding: 12px; background: #e8f5e8; border-radius: 8px; text-align: center;">
                        <div style="font-size: 16px; font-weight: bold; color: #2e7d32; margin-bottom: 4px;">‚úÖ Friend Added!</div>
                        <div style="font-size: 14px; color: #666;">You're now connected with ${result.friendName}</div>
                    </div>
                `;
                
                input.value = '';
                showNotification(`You're now friends with ${result.friendName}! üéâ`, 'success');
                
                // Refresh the friends list
                setTimeout(() => {
                    loadGroupMembers();
                    // Close modal after success
                    document.querySelector('div[style*="position: fixed"]')?.remove();
                }, 2000);
                
            } catch (error) {
                console.error('Error adding friend by code:', error);
                resultDisplay.innerHTML = `
                    <div style="padding: 12px; background: #ffebee; border-radius: 8px; text-align: center;">
                        <div style="font-size: 16px; font-weight: bold; color: #c62828; margin-bottom: 4px;">‚ùå Failed</div>
                        <div style="font-size: 14px; color: #666;">${error.message}</div>
                    </div>
                `;
                showNotification('Failed to add friend: ' + error.message, 'error');
            }
        }
        
        async function addFriendDirectly(friendName) {
            try {
                // Use SupabaseSync to add friend (handles both localStorage and Supabase)
                const friendData = {
                    name: friendName,
                    avatar: 'üë§'
                };
                
                const newFriend = await window.SupabaseSync.addFriend(friendData);
                showNotification(`Added ${friendName} as friend! üéâ`, 'success');
                
                // Reload friends list
                loadGroupMembers();
                
                console.log('‚úÖ Friend added successfully:', newFriend);
            } catch (error) {
                console.error('Error adding friend:', error);
                showNotification('Failed to add friend: ' + error.message, 'warning');
            }
        }
        
        function cleanupFakeFriends() {
            if (confirm('This will remove all fake/duplicate friends. Are you sure?')) {
                try {
                    // Clear all friends from localStorage
                    const data = JSON.parse(localStorage.getItem('splitzee_data') || '{}');
                    data.friends = {};
                    localStorage.setItem('splitzee_data', JSON.stringify(data));
                    
                    showNotification('All friends cleared! üßπ', 'success');
                    
                    // Reload the page to refresh everything
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } catch (error) {
                    showNotification('Failed to cleanup friends: ' + error.message, 'warning');
                }
            }
        }
        
        function resetAllData() {
            if (confirm('‚ö†Ô∏è This will permanently delete ALL data (expenses, friends, everything). Are you absolutely sure?')) {
                if (confirm('üö® FINAL WARNING: This action cannot be undone. All your expenses and friends will be lost forever!')) {
                    try {
                        // Clear all localStorage data
                        localStorage.clear(); // Clear everything to be absolutely sure
                        
                        // Also clear session storage
                        sessionStorage.clear();
                        
                        showNotification('All data cleared! Starting fresh... üåü', 'success');
                        
                        // Reload the page to reinitialize everything
                        setTimeout(() => {
                            location.reload();
                        }, 1500);
                    } catch (error) {
                        showNotification('Failed to reset data: ' + error.message, 'warning');
                    }
                }
            }
        }

        function settleUp() {
            if (Math.abs(currentBalance) > 0.01) {
                const settledAmount = Math.abs(currentBalance);
                const wasOwed = currentBalance > 0;
                
                updateBalance(0);
                
                if (wasOwed) {
                    showNotification(`Received $${settledAmount.toFixed(2)}! You're all settled up! üí∞`, 'success');
                } else {
                    showNotification(`Paid $${settledAmount.toFixed(2)}! You're all settled up! ‚úÖ`, 'success');
                }
                
                if (navigator.vibrate) {
                    navigator.vibrate([100, 50, 100]);
                }
            } else {
                showNotification('You\'re already settled up! üëç', 'info');
            }
        }

        function openGroup(groupName) {
            showNotification(`Opening ${groupName}... üìÇ`, 'info');
            if (navigator.vibrate) {
                navigator.vibrate(30);
            }
            
            // Simulate navigation delay
            setTimeout(() => {
                showNotification(`${groupName} details loaded! View expenses, add members, or split costs.`, 'info');
            }, 1200);
        }

        function viewExpense(expenseId) {
            // Store expense ID in localStorage for the edit form to pick up
            localStorage.setItem('splitzee_edit_expense_id', expenseId);
            
            // Navigate to expense form with edit mode
            window.location.href = 'expense-form-new.html?edit=' + expenseId;
        }
        
        function deleteExpense(expenseId) {
            if (confirm('Are you sure you want to delete this expense? This action cannot be undone.')) {
                try {
                    window.SupabaseSync.deleteExpense(expenseId);
                    showNotification('Expense deleted successfully! üóëÔ∏è', 'success');
                    
                    // Refresh the display
                    setTimeout(() => {
                        loadDashboard();
                    }, 500);
                    
                } catch (error) {
                    console.error('Error deleting expense:', error);
                    showNotification('Failed to delete expense: ' + error.message, 'error');
                }
            }
        }

        // Auto-refresh dashboard when returning from expense form
        function refreshDashboard() {
            console.log('üîÑ Refreshing dashboard...');
            loadExpenseData();
            loadUsageStats();
        }
        
        // Listen for storage changes (from other tabs/windows)
        window.addEventListener('storage', function(e) {
            if (e.key === 'splitzee_data') {
                console.log('üíæ Data changed in another tab, refreshing...');
                refreshDashboard();
            }
        });
        
        // Auto-refresh disabled - only refresh on user actions
        
        // Debug function to check localStorage
        function debugLocalStorage() {
            console.log('üîç localStorage contents:');
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const value = localStorage.getItem(key);
                console.log(`  ${key}:`, value.length > 200 ? value.substring(0, 200) + '...' : value);
            }
            
            const splitzeeData = localStorage.getItem('splitzee_data');
            if (splitzeeData) {
                try {
                    const parsed = JSON.parse(splitzeeData);
                    console.log('üìä Parsed splitzee_data:', parsed);
                } catch (e) {
                    console.log('‚ùå Error parsing splitzee_data:', e);
                }
            }
        }
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', async function() {
            // Wait for OfflineStorage to initialize
            await new Promise(resolve => setTimeout(resolve, 100));
            
            // Initialize app
            await initializeApp();
            
            console.log('‚úÖ Splitzee App Loaded');
            console.log('üí∞ Ready for expense splitting and management');
            console.log('üì± Optimized for iOS and mobile devices');
            console.log('üîê Backend: SupabaseSync (Online-only)');
            console.log('üë§ User authenticated:', currentUser ? currentUser.name : 'None');
        });

        // Add touch feedback for better iOS experience
        document.addEventListener('touchstart', function(e) {
            const element = e.target.closest('.card, .button, .fab, .group-item, .expense-item');
            if (element) {
                element.style.transition = 'transform 0.1s ease';
            }
        });

        // No service worker needed for server-only mode
    </script>
</body>
</html>