<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Splitzee - Expense Splitting</title>
    
    <!-- PWA Meta Tags -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Splitzee">
    <meta name="theme-color" content="#6200EE">
    
    <!-- Icon -->
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDE4MCAxODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjE4MCIgaGVpZ2h0PSIxODAiIHJ4PSI0MCIgZmlsbD0iIzYyMDBFRSIvPjx0ZXh0IHg9IjkwIiB5PSIxMTAiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IndoaXRlIiBmb250LXNpemU9IjgwIiBmb250LWZhbWlseT0ic3lzdGVtLXVpIj7wn5KwPC90ZXh0Pjwvc3ZnPg==">
    
    <!-- Storage System -->
    <script src="offline-storage.js?v=11"></script>
    <script src="supabase-integration.js?v=11"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background-color: #f5f5f5;
            padding: 16px;
            color: #333;
            padding-top: env(safe-area-inset-top, 44px);
            padding-bottom: env(safe-area-inset-bottom, 34px);
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            background: linear-gradient(135deg, #6200EE, #3700B3);
            border-radius: 12px;
            margin-bottom: 20px;
            color: white;
            box-shadow: 0 4px 12px rgba(98, 0, 238, 0.3);
        }

        .header-left {
            display: flex;
            align-items: center;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 12px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .user-avatar:hover {
            transform: scale(1.05);
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .user-email {
            font-size: 12px;
            opacity: 0.8;
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        .header-button {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
        }

        .header-button:active {
            background: rgba(255,255,255,0.3);
        }

        .title {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .subtitle {
            font-size: 16px;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .card:active {
            transform: scale(0.98);
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 16px;
        }

        .balance-card {
            text-align: center;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            position: relative;
            overflow: hidden;
        }

        .balance-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
            transform: rotate(45deg);
        }

        .balance-amount {
            font-size: 42px;
            font-weight: bold;
            margin-bottom: 8px;
            position: relative;
            z-index: 1;
        }

        .balance-text {
            font-size: 16px;
            opacity: 0.9;
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
        }

        .button {
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 14px 28px;
            border-radius: 25px;
            border: none;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            position: relative;
            z-index: 1;
        }

        .button:active {
            transform: scale(0.95);
            background: rgba(255,255,255,0.3);
        }

        .primary-button {
            background: #6200EE;
            color: white;
            width: 100%;
            border-radius: 12px;
            font-size: 18px;
            padding: 16px;
            box-shadow: 0 4px 12px rgba(98, 0, 238, 0.3);
        }

        .primary-button:active {
            background: #3700B3;
            transform: scale(0.98);
        }

        .group-item, .expense-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background-color 0.2s ease;
            border-radius: 8px;
            margin: 0 -8px;
            padding-left: 8px;
            padding-right: 8px;
        }

        .group-item:active, .expense-item:active {
            background-color: #f8f9fa;
        }

        .group-item:last-child, .expense-item:last-child {
            border-bottom: none;
        }

        .group-name {
            font-size: 17px;
            font-weight: 600;
            color: #333;
        }

        .group-amount {
            font-size: 17px;
            font-weight: 700;
            color: #6200EE;
        }

        .expense-description {
            font-size: 16px;
            font-weight: 500;
            color: #333;
        }

        .expense-group {
            font-size: 13px;
            color: #666;
            margin-top: 4px;
        }

        .expense-amount {
            font-size: 16px;
            font-weight: 600;
            color: #4CAF50;
        }

        .fab {
            position: fixed;
            bottom: 30px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #6200EE, #3700B3);
            border-radius: 30px;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(98, 0, 238, 0.4);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .fab:active {
            transform: scale(0.9);
            box-shadow: 0 4px 16px rgba(98, 0, 238, 0.6);
        }

        .notification {
            position: fixed;
            top: 60px;
            left: 20px;
            right: 20px;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 16px 20px;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 500;
            transform: translateY(-120px);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 2000;
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.3);
        }

        .notification.show {
            transform: translateY(0);
            opacity: 1;
        }

        .section-divider {
            height: 1px;
            background: linear-gradient(90deg, transparent, #e0e0e0, transparent);
            margin: 8px 0;
        }

        .group-icon {
            font-size: 20px;
            margin-right: 12px;
        }

        .expense-icon {
            width: 8px;
            height: 8px;
            background: #4CAF50;
            border-radius: 50%;
            margin-right: 12px;
            flex-shrink: 0;
            margin-top: 6px;
        }

        .balance-trend {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 4px;
        }

        @media (max-width: 400px) {
            body {
                padding: 12px;
            }
            
            .container {
                padding: 0;
            }
        }

        /* Add smooth scrolling */
        html {
            scroll-behavior: smooth;
        }

        /* Loading animation for interactions */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .pulse {
            animation: pulse 0.6s ease-in-out;
        }
    </style>
</head>
<body>
    <div class="notification" id="notification">
        Welcome to SplitWise! 🎉
    </div>

    <div class="container">
        <div class="header">
            <div class="header-left">
                <div class="user-avatar" onclick="openProfile()" id="userAvatar">👤</div>
                <div class="user-info">
                    <div class="user-name" id="userName">Demo User</div>
                    <div class="user-email" id="userEmail">demo@splitwise.com</div>
                </div>
            </div>
            <div class="header-actions">
                <button class="header-button" onclick="debugLocalStorage()" title="Debug Data">🔍</button>
                <button class="header-button" onclick="resetAllData()" title="Reset All Data">🗑️</button>
                <button class="header-button" onclick="cleanupFakeFriends()" title="Cleanup Friends">🧹</button>
                <button class="header-button" onclick="openUsers()" title="Manage Users">👥</button>
                <button class="header-button" onclick="openProfile()" title="Profile">⚙️</button>
            </div>
        </div>

        <!-- Balance Card -->
        <div class="card balance-card">
            <div class="card-title">Your Balance</div>
            <div class="balance-amount" id="balanceAmount">$0.00</div>
            <div class="balance-text" id="balanceText">All settled up</div>
            <div class="balance-trend">↗️ +$25.50 this week</div>
            <button class="button" onclick="settleUp()">Settle Up</button>
        </div>

        <!-- Subscription Status (Free users only) -->
        <div class="card" id="subscriptionCard" style="display: none;">
            <div class="card-title">📊 Usage This Month</div>
            <div style="margin-bottom: 16px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span>Expenses</span>
                    <span id="expenseUsage">0/10</span>
                </div>
                <div style="background: #f0f0f0; border-radius: 8px; height: 8px; overflow: hidden;">
                    <div id="expenseProgress" style="background: linear-gradient(90deg, #4CAF50, #FF9800); height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                </div>
            </div>
            <div style="margin-bottom: 16px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span>Groups</span>
                    <span id="groupUsage">0/3</span>
                </div>
                <div style="background: #f0f0f0; border-radius: 8px; height: 8px; overflow: hidden;">
                    <div id="groupProgress" style="background: linear-gradient(90deg, #4CAF50, #FF9800); height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                </div>
            </div>
            <button class="button" style="background: linear-gradient(135deg, #FFD700, #FFA500); color: white;" onclick="upgradeToPremium()">
                💎 Upgrade to Premium
            </button>
        </div>

        <!-- Quick Actions -->
        <div class="card">
            <div class="card-title">Quick Actions</div>
            <button class="button primary-button" onclick="addExpense()" id="addExpenseButton">
                ➕ Add Expense
            </button>
            <button class="button" style="background: #4CAF50; color: white;" onclick="openSettlement()">
                ⚖️ Settlement Calculator
            </button>
        </div>

        <!-- Groups/Friends -->
        <div class="card" id="groupsCard">
            <div class="card-title">Your Friends</div>
            <div style="text-align: center; padding: 20px; color: #666;">
                <div style="font-size: 48px; margin-bottom: 12px;">👥</div>
                <div>Loading friends...</div>
            </div>
        </div>

        <!-- Recent Expenses -->
        <div class="card" id="recentExpensesCard">
            <div class="card-title">Recent Expenses</div>
            <div style="text-align: center; padding: 20px; color: #666;">
                <div style="font-size: 48px; margin-bottom: 12px;">💰</div>
                <div>Loading expenses...</div>
            </div>
        </div>

        <!-- Summary Card -->
        <div class="card">
            <div class="card-title">This Month</div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <div style="font-size: 14px; color: #666;">Total Expenses</div>
                    <div id="totalExpensesAmount" style="font-size: 24px; font-weight: bold; color: #333;">$0.00</div>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 14px; color: #666;">Your Share</div>
                    <div id="yourShareAmount" style="font-size: 24px; font-weight: bold; color: #6200EE;">$0.00</div>
                </div>
            </div>
        </div>
    </div>

    <button class="fab" onclick="addExpense()" title="Add Expense">+</button>

    <script>
        let currentBalance = 0;
        let currentUser = null;

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            
            // Change color based on type
            if (type === 'success') {
                notification.style.background = 'linear-gradient(135deg, #4CAF50, #45a049)';
            } else if (type === 'info') {
                notification.style.background = 'linear-gradient(135deg, #2196F3, #1976D2)';
            } else if (type === 'warning') {
                notification.style.background = 'linear-gradient(135deg, #FF9800, #F57C00)';
            }
            
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function updateBalance(newBalance) {
            currentBalance = newBalance;
            const balanceElement = document.getElementById('balanceAmount');
            const textElement = document.getElementById('balanceText');
            
            // Add pulse animation
            balanceElement.classList.add('pulse');
            setTimeout(() => balanceElement.classList.remove('pulse'), 600);
            
            balanceElement.textContent = `$${Math.abs(currentBalance).toFixed(2)}`;
            
            if (currentBalance > 0) {
                textElement.textContent = `You are owed $${currentBalance.toFixed(2)}`;
                balanceElement.style.color = '#4CAF50';
            } else if (currentBalance < 0) {
                textElement.textContent = `You owe $${Math.abs(currentBalance).toFixed(2)}`;
                balanceElement.style.color = '#F44336';
            } else {
                textElement.textContent = 'You are all settled up!';
                balanceElement.style.color = '#4CAF50';
            }
        }

        async function addExpense() {
            // Check if user can create expense
            const stats = window.OfflineStorage.getUsageStats();
            
            if (!currentUser.isPremium && stats.expensesThisMonth >= 5) {
                showNotification('You\'ve reached the monthly limit of 5 expenses. Upgrade to Premium for unlimited expenses! 💎', 'warning');
                setTimeout(() => {
                    window.location.href = 'premium.html';
                }, 2000);
                return;
            }
            
            // Navigate to expense form
            window.location.href = 'expense-form-new.html';
        }

        function upgradeToPremium() {
            window.location.href = 'premium.html';
        }

        function openSettlement() {
            window.location.href = 'settlement-calculator.html';
        }

        function openProfile() {
            window.location.href = 'profile.html';
        }

        function openUsers() {
            window.location.href = 'users.html';
        }

        async function loadUserSession() {
            try {
                // Get current user from OfflineStorage
                const user = window.OfflineStorage.getUser();
                
                if (!user) {
                    // No user found, initialize anonymous user
                    window.OfflineStorage.initializeUser();
                    const newUser = window.OfflineStorage.getUser();
                    currentUser = newUser;
                } else {
                    currentUser = user;
                }
                
                // Update header with user info
                document.getElementById('userName').textContent = currentUser.name;
                document.getElementById('userEmail').textContent = currentUser.email || 'anonymous@splitwise.local';
                
                // Update avatar
                const avatarElement = document.getElementById('userAvatar');
                if (currentUser.avatar && currentUser.avatar.includes('http')) {
                    avatarElement.innerHTML = `<img src="${currentUser.avatar}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;" alt="Profile">`;
                } else {
                    const initials = currentUser.name.split(' ').map(n => n[0]).join('').toUpperCase();
                    avatarElement.textContent = initials;
                }
                
                return true;
            } catch (error) {
                console.error('Error loading session:', error);
                return false;
            }
        }

        async function checkAuthentication() {
            const success = await loadUserSession();
            if (!success) {
                return;
            }
            
            // Load usage stats and show subscription card for free users
            await loadUsageStats();
            
            // Load and display actual expenses
            await loadExpenseData();
            
            // Show welcome message for new sessions
            const isNewSession = !sessionStorage.getItem('app_initialized');
            if (isNewSession) {
                sessionStorage.setItem('app_initialized', 'true');
                const tier = currentUser.isPremium ? '💎 Premium' : '🆓 Free';
                showNotification(`✅ ${tier} | Welcome back, ${currentUser.name}! 👋`);
            }
        }

        async function loadUsageStats() {
            try {
                const stats = window.OfflineStorage.getUsageStats();
                
                // Show subscription card only for free users
                if (!currentUser.isPremium) {
                    document.getElementById('subscriptionCard').style.display = 'block';
                    
                    // Update expense usage (handle undefined values)
                    const expensesUsed = stats.expensesThisMonth || 0;
                    const groupsUsed = stats.groupsThisMonth || 0;
                    
                    document.getElementById('expenseUsage').textContent = `${expensesUsed}/5`;
                    const expensePercent = (expensesUsed / 5) * 100;
                    document.getElementById('expenseProgress').style.width = `${Math.min(expensePercent, 100)}%`;
                    
                    // Update group usage
                    document.getElementById('groupUsage').textContent = `${groupsUsed}/3`;
                    const groupPercent = (groupsUsed / 3) * 100;
                    document.getElementById('groupProgress').style.width = `${Math.min(groupPercent, 100)}%`;
                    
                    // Show warning if approaching limits
                    if (stats.expensesThisMonth >= 4) {
                        showNotification(`You've used ${stats.expensesThisMonth}/5 expenses this month`, 'info');
                    }
                    if (stats.groupsThisMonth >= 2) {
                        showNotification(`You've created ${stats.groupsThisMonth}/3 groups`, 'info');
                    }
                }
                
            } catch (error) {
                console.error('Error loading usage stats:', error);
            }
        }

        async function loadExpenseData() {
            try {
                const expenses = window.OfflineStorage.getExpenses();
                const recentExpenses = expenses.slice(-3).reverse(); // Get last 3 expenses, newest first
                
                // Debug: Log expense data to understand structure
                console.log('📊 Debug - Expenses found:', expenses.length);
                if (expenses.length > 0) {
                    expenses.forEach((expense, i) => {
                        console.log(`Expense ${i}:`, {
                            id: expense.id,
                            description: expense.description,
                            amount: expense.amount,
                            splits: expense.splits,
                            participants: expense.participants
                        });
                    });
                }
                console.log('🧑 Current user:', currentUser);
                
                // Calculate totals - Force reset if no expenses
                const totalAmount = expenses.length > 0 ? expenses.reduce((sum, expense) => sum + expense.amount, 0) : 0;
                let userShare = 0; // Start with 0
                
                if (expenses.length > 0) {
                    userShare = expenses.reduce((sum, expense) => {
                    // Try multiple ways to find user's share
                    let userSplit = 0;
                    if (expense.splits) {
                        // Check all possible keys for user's share
                        const possibleKeys = [
                            'You',
                            currentUser.name,
                            currentUser.id,
                            'Me',
                            currentUser.name?.toLowerCase(),
                            currentUser.name?.toUpperCase()
                        ];
                        
                        for (const key of possibleKeys) {
                            if (key && expense.splits[key] !== undefined) {
                                userSplit = expense.splits[key];
                                break;
                            }
                        }
                        
                        // If still no match, check if this is creator's expense and split equally
                        if (userSplit === 0 && expense.createdBy === currentUser.id && expense.participants) {
                            userSplit = expense.amount / expense.participants.length;
                        }
                        
                        // Debug log for each expense
                        console.log(`💰 Expense "${expense.description}": userSplit = ${userSplit}`, {
                            'You': expense.splits['You'],
                            [currentUser.name]: expense.splits[currentUser.name],
                            [currentUser.id]: expense.splits[currentUser.id],
                            allSplits: expense.splits,
                            createdBy: expense.createdBy,
                            currentUserId: currentUser.id,
                            participants: expense.participants
                        });
                    }
                        return sum + userSplit;
                    }, 0);
                } else {
                    console.log('🔄 No expenses found - userShare set to 0');
                }
                
                console.log('📈 Totals calculated:', { totalAmount, userShare });
                
                // Update balance card
                currentBalance = userShare; // Your balance is what you're owed/owe
                updateBalance(currentBalance);
                
                // Update summary card totals using specific IDs
                const totalExpenseDiv = document.getElementById('totalExpensesAmount');
                const yourShareDiv = document.getElementById('yourShareAmount');
                
                console.log('💰 Found total div by ID:', !!totalExpenseDiv, 'Found share div by ID:', !!yourShareDiv);
                
                if (totalExpenseDiv) {
                    totalExpenseDiv.textContent = `$${totalAmount.toFixed(2)}`;
                    console.log('✅ Updated total to:', totalExpenseDiv.textContent);
                } else {
                    console.log('❌ Total expense div not found by ID');
                }
                
                if (yourShareDiv) {
                    yourShareDiv.textContent = `$${userShare.toFixed(2)}`;
                    console.log('✅ Updated share to:', yourShareDiv.textContent);
                } else {
                    console.log('❌ Your share div not found by ID');
                }
                
                // Update recent expenses list  
                const expenseContainer = document.getElementById('recentExpensesCard');
                if (recentExpenses.length > 0) {
                    const expenseList = recentExpenses.map((expense, index) => {
                        const timeAgo = getTimeAgo(expense.createdAt);
                        let userAmount = 0;
                        
                        if (expense.splits) {
                            // Use same lookup logic as total calculation
                            const possibleKeys = [
                                'You',
                                currentUser.name,
                                currentUser.id,
                                'Me',
                                currentUser.name?.toLowerCase(),
                                currentUser.name?.toUpperCase()
                            ];
                            
                            for (const key of possibleKeys) {
                                if (key && expense.splits[key] !== undefined) {
                                    userAmount = expense.splits[key];
                                    break;
                                }
                            }
                            
                            // Fallback for creator's expense
                            if (userAmount === 0 && expense.createdBy === currentUser.id && expense.participants) {
                                userAmount = expense.amount / expense.participants.length;
                            }
                        }
                        
                        return `
                            <div class="expense-item" onclick="viewExpense('${expense.id}')">
                                <div style="display: flex; align-items: flex-start;">
                                    <div class="expense-icon"></div>
                                    <div>
                                        <div class="expense-description">${expense.description}</div>
                                        <div class="expense-group">${expense.category} • ${timeAgo}</div>
                                    </div>
                                </div>
                                <div class="expense-amount">$${userAmount.toFixed(2)}</div>
                            </div>
                            ${index < recentExpenses.length - 1 ? '<div class="section-divider"></div>' : ''}
                        `;
                    }).join('');
                    
                    expenseContainer.innerHTML = `
                        <div class="card-title">Recent Expenses</div>
                        ${expenseList}
                    `;
                } else {
                    // Show empty state for expenses
                    expenseContainer.innerHTML = `
                        <div class="card-title">Recent Expenses</div>
                        <div style="text-align: center; padding: 20px; color: #666;">
                            <div style="font-size: 48px; margin-bottom: 12px;">📝</div>
                            <div>No expenses yet</div>
                            <div style="font-size: 14px; margin-top: 8px;">Add your first expense to get started!</div>
                            <button class="button" style="background: #6200EE; color: white; margin-top: 16px;" onclick="addExpense()">
                                ➕ Add First Expense
                            </button>
                        </div>
                    `;
                }
                
                // Load and display friends/group members
                await loadGroupMembers();
                
            } catch (error) {
                console.error('Error loading expense data:', error);
            }
        }
        
        function getTimeAgo(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;
            const minutes = Math.floor(diff / (1000 * 60));
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            
            if (minutes < 1) {
                return 'Just now';
            } else if (minutes < 60) {
                return `${minutes} minutes ago`;
            } else if (hours < 24) {
                return `${hours} hours ago`;
            } else {
                return `${days} days ago`;
            }
        }
        
        async function loadGroupMembers() {
            try {
                const friends = window.OfflineStorage.getFriends();
                
                // Update the groups section with actual friends
                const groupsCard = document.getElementById('groupsCard');
                if (friends.length > 0) {
                    const friendsList = friends.map(friend => {
                        return `
                            <div class="group-item" onclick="openFriendExpenses('${friend.id}')">
                                <div>
                                    <span class="group-icon">👤</span>
                                    <span class="group-name">${friend.name}</span>
                                </div>
                                <div class="group-amount">Active</div>
                            </div>
                            <div class="section-divider"></div>
                        `;
                    }).join('');
                    
                    groupsCard.innerHTML = `
                        <div class="card-title">Your Friends</div>
                        ${friendsList}
                        <div class="group-item" onclick="addFriend()" style="opacity: 0.7;">
                            <div>
                                <span class="group-icon">➕</span>
                                <span class="group-name">Add Friend</span>
                            </div>
                            <div class="group-amount">Tap</div>
                        </div>
                    `;
                } else {
                    groupsCard.innerHTML = `
                        <div class="card-title">Your Friends</div>
                        <div style="text-align: center; padding: 20px; color: #666;">
                            <div style="font-size: 48px; margin-bottom: 12px;">👥</div>
                            <div>No friends added yet</div>
                            <div style="font-size: 14px; margin-top: 8px;">Add friends to split expenses together!</div>
                            <button class="button" style="background: #4CAF50; color: white; margin-top: 16px;" onclick="addFriend()">
                                ➕ Add Your First Friend
                            </button>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Error loading group members:', error);
            }
        }
        
        function openFriendExpenses(friendId) {
            try {
                const expenses = window.OfflineStorage.getExpenses();
                const friends = window.OfflineStorage.getFriends();
                const friend = friends.find(f => f.id === friendId);
                
                console.log('🔍 Opening expenses for friend:', friendId);
                console.log('👥 All friends:', friends);
                console.log('🎯 Found friend:', friend);
                console.log('💰 All expenses:', expenses);
                
                if (!friend) {
                    showNotification('Friend not found', 'warning');
                    return;
                }
                
                // Find expenses that include this friend (check multiple possible names)
                const sharedExpenses = expenses.filter(expense => {
                    if (!expense.participants) return false;
                    
                    // Check if friend is included by name
                    if (expense.participants.includes(friend.name)) {
                        return true;
                    }
                    
                    // For backward compatibility: if expense has "Person 2" and you only have 1 friend, assume it's this friend
                    if (expense.participants.includes('Person 2')) {
                        const friends = window.OfflineStorage.getFriends();
                        if (friends.length === 1 && friends[0].id === friend.id) {
                            return true;
                        }
                    }
                    
                    // Check if friend has splits in this expense
                    return expense.splits && expense.splits[friend.name] !== undefined;
                });
                
                if (sharedExpenses.length === 0) {
                    showNotification(`No shared expenses with ${friend.name} yet`, 'info');
                    return;
                }
                
                // Show a popup or navigate to expense view
                let expensesList = sharedExpenses.map(expense => {
                    const userSplit = expense.splits?.[currentUser.name] || expense.splits?.['You'] || 0;
                    const friendSplit = expense.splits?.[friend.name] || 0;
                    const timeAgo = getTimeAgo(expense.createdAt);
                    
                    return `
                        <div style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 12px; margin: 8px 0;">
                            <div style="font-weight: 600; color: #333;">${expense.description}</div>
                            <div style="font-size: 14px; color: #666; margin: 4px 0;">${expense.category} • ${timeAgo}</div>
                            <div style="display: flex; justify-content: space-between; font-size: 14px;">
                                <div>Total: $${expense.amount.toFixed(2)}</div>
                                <div>Your share: $${userSplit.toFixed(2)}</div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Create a modal-like display
                const modalHTML = `
                    <div id="friendExpensesModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px;">
                        <div style="background: white; border-radius: 16px; max-width: 400px; width: 100%; max-height: 80vh; overflow-y: auto; padding: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                <h3 style="margin: 0; color: #333;">Expenses with ${friend.name}</h3>
                                <button onclick="closeFriendExpensesModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">×</button>
                            </div>
                            <div style="color: #666; margin-bottom: 16px;">${sharedExpenses.length} shared expense${sharedExpenses.length !== 1 ? 's' : ''}</div>
                            ${expensesList}
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                showNotification(`Found ${sharedExpenses.length} expenses with ${friend.name}`, 'success');
                
            } catch (error) {
                console.error('Error loading friend expenses:', error);
                showNotification('Failed to load friend expenses', 'warning');
            }
        }
        
        function closeFriendExpensesModal() {
            const modal = document.getElementById('friendExpensesModal');
            if (modal) {
                modal.remove();
            }
        }
        
        function addFriend() {
            const friendName = prompt('Enter friend\'s name:');
            if (friendName && friendName.trim()) {
                addFriendDirectly(friendName.trim());
            }
        }
        
        function addFriendDirectly(friendName) {
            try {
                // Add friend directly to localStorage without server
                const data = JSON.parse(localStorage.getItem('splitzee_data') || '{}');
                if (!data.friends) data.friends = {};
                
                const friendId = 'friend_' + Date.now() + '_' + Math.random().toString(36).substr(2, 8);
                data.friends[friendId] = {
                    id: friendId,
                    name: friendName,
                    avatar: '👤',
                    added: Date.now()
                };
                
                localStorage.setItem('splitzee_data', JSON.stringify(data));
                showNotification(`Added ${friendName} as friend! 🎉`, 'success');
                
                // Reload friends list
                loadGroupMembers();
            } catch (error) {
                showNotification('Failed to add friend: ' + error.message, 'warning');
            }
        }
        
        function cleanupFakeFriends() {
            if (confirm('This will remove all fake/duplicate friends. Are you sure?')) {
                try {
                    // Clear all friends from localStorage
                    const data = JSON.parse(localStorage.getItem('splitzee_data') || '{}');
                    data.friends = {};
                    localStorage.setItem('splitzee_data', JSON.stringify(data));
                    
                    showNotification('All friends cleared! 🧹', 'success');
                    
                    // Reload the page to refresh everything
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } catch (error) {
                    showNotification('Failed to cleanup friends: ' + error.message, 'warning');
                }
            }
        }
        
        function resetAllData() {
            if (confirm('⚠️ This will permanently delete ALL data (expenses, friends, everything). Are you absolutely sure?')) {
                if (confirm('🚨 FINAL WARNING: This action cannot be undone. All your expenses and friends will be lost forever!')) {
                    try {
                        // Clear all localStorage data
                        localStorage.clear(); // Clear everything to be absolutely sure
                        
                        // Also clear session storage
                        sessionStorage.clear();
                        
                        showNotification('All data cleared! Starting fresh... 🌟', 'success');
                        
                        // Reload the page to reinitialize everything
                        setTimeout(() => {
                            location.reload();
                        }, 1500);
                    } catch (error) {
                        showNotification('Failed to reset data: ' + error.message, 'warning');
                    }
                }
            }
        }

        function settleUp() {
            if (Math.abs(currentBalance) > 0.01) {
                const settledAmount = Math.abs(currentBalance);
                const wasOwed = currentBalance > 0;
                
                updateBalance(0);
                
                if (wasOwed) {
                    showNotification(`Received $${settledAmount.toFixed(2)}! You're all settled up! 💰`, 'success');
                } else {
                    showNotification(`Paid $${settledAmount.toFixed(2)}! You're all settled up! ✅`, 'success');
                }
                
                if (navigator.vibrate) {
                    navigator.vibrate([100, 50, 100]);
                }
            } else {
                showNotification('You\'re already settled up! 👍', 'info');
            }
        }

        function openGroup(groupName) {
            showNotification(`Opening ${groupName}... 📂`, 'info');
            if (navigator.vibrate) {
                navigator.vibrate(30);
            }
            
            // Simulate navigation delay
            setTimeout(() => {
                showNotification(`${groupName} details loaded! View expenses, add members, or split costs.`, 'info');
            }, 1200);
        }

        function viewExpense(expenseId) {
            // Store expense ID in localStorage for the edit form to pick up
            localStorage.setItem('splitzee_edit_expense_id', expenseId);
            
            // Navigate to expense form with edit mode
            window.location.href = 'expense-form-new.html?edit=' + expenseId;
        }
        
        function deleteExpense(expenseId) {
            if (confirm('Are you sure you want to delete this expense? This action cannot be undone.')) {
                try {
                    window.OfflineStorage.deleteExpense(expenseId);
                    showNotification('Expense deleted successfully! 🗑️', 'success');
                    
                    // Refresh the display
                    setTimeout(() => {
                        loadDashboard();
                    }, 500);
                    
                } catch (error) {
                    console.error('Error deleting expense:', error);
                    showNotification('Failed to delete expense: ' + error.message, 'error');
                }
            }
        }

        // Auto-refresh dashboard when returning from expense form
        function refreshDashboard() {
            console.log('🔄 Refreshing dashboard...');
            loadExpenseData();
            loadUsageStats();
        }
        
        // Listen for storage changes (from other tabs/windows)
        window.addEventListener('storage', function(e) {
            if (e.key === 'splitzee_data') {
                console.log('💾 Data changed in another tab, refreshing...');
                refreshDashboard();
            }
        });
        
        // Auto-refresh every 5 seconds when page is visible
        setInterval(() => {
            if (!document.hidden) {
                refreshDashboard();
            }
        }, 5000);
        
        // Debug function to check localStorage
        function debugLocalStorage() {
            console.log('🔍 localStorage contents:');
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const value = localStorage.getItem(key);
                console.log(`  ${key}:`, value.length > 200 ? value.substring(0, 200) + '...' : value);
            }
            
            const splitzeeData = localStorage.getItem('splitzee_data');
            if (splitzeeData) {
                try {
                    const parsed = JSON.parse(splitzeeData);
                    console.log('📊 Parsed splitzee_data:', parsed);
                } catch (e) {
                    console.log('❌ Error parsing splitzee_data:', e);
                }
            }
        }
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', async function() {
            // Debug localStorage first
            debugLocalStorage();
            
            // Wait for OfflineStorage to initialize
            await new Promise(resolve => setTimeout(resolve, 100));
            
            // Check authentication first
            await checkAuthentication();
            
            console.log('🚀 Splitzee Production App Loaded');
            console.log('💰 Ready for expense splitting and management');
            console.log('📱 Optimized for iOS and mobile devices');
            console.log('🔐 Backend: OfflineStorage (Server-only)');
            console.log('👤 User authenticated:', currentUser ? currentUser.name : 'None');
        });

        // Add touch feedback for better iOS experience
        document.addEventListener('touchstart', function(e) {
            const element = e.target.closest('.card, .button, .fab, .group-item, .expense-item');
            if (element) {
                element.style.transition = 'transform 0.1s ease';
            }
        });

        // No service worker needed for server-only mode
    </script>
</body>
</html>