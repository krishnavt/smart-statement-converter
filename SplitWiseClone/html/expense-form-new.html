<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Expense - Splitzee</title>
    
    <!-- Storage System -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/supabase-config.js?v=19"></script>
    <script src="../js/offline-storage.js?v=19"></script>
    <script src="../js/supabase-integration.js?v=19"></script>
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Splitzee">
    <meta name="theme-color" content="#6200EE">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background-color: #f5f5f5;
            color: #333;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #6200EE, #3700B3);
            color: white;
            padding: 20px;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 8px rgba(98, 0, 238, 0.3);
        }

        .back-button {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            margin-right: 16px;
            padding: 8px;
            cursor: pointer;
        }

        .header-title {
            font-size: 20px;
            font-weight: 600;
        }

        .draft-indicator {
            background: rgba(255,255,255,0.2);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: auto;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 16px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 16px;
            font-weight: 500;
            color: #333;
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            padding: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 18px;
            transition: border-color 0.3s ease;
            background: #f8f9fa;
        }

        .form-input:focus {
            outline: none;
            border-color: #6200EE;
            background: white;
        }

        .amount-input {
            font-size: 24px;
            font-weight: 600;
            text-align: center;
            color: #6200EE;
        }

        .calculator-container {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 16px;
            margin-top: 12px;
        }

        .calculator-display {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 16px;
            font-size: 20px;
            font-weight: 600;
            text-align: right;
            margin-bottom: 16px;
            color: #333;
        }

        .calculator-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }

        .calc-button {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 16px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .calc-button:active {
            transform: scale(0.95);
            background: #f0f0f0;
        }

        .calc-button.operator {
            background: #6200EE;
            color: white;
            border-color: #6200EE;
        }

        .calc-button.equals {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }

        .quick-split {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .quick-button {
            background: #e3f2fd;
            border: 2px solid #2196F3;
            color: #1976D2;
            padding: 12px 8px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .quick-button.active {
            background: #2196F3;
            color: white;
        }

        .split-method {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .method-button {
            flex: 1;
            background: white;
            border: 2px solid #e0e0e0;
            color: #666;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .method-button.active {
            background: #6200EE;
            color: white;
            border-color: #6200EE;
        }

        .people-list {
            margin-bottom: 20px;
        }

        .person-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
            transition: opacity 0.3s ease;
        }

        .person-item:last-child {
            border-bottom: none;
        }

        .person-item.excluded {
            opacity: 0.5;
        }

        .person-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .person-checkbox {
            width: 20px;
            height: 20px;
            accent-color: #6200EE;
        }

        .person-name {
            font-size: 16px;
            font-weight: 500;
        }

        .person-amount {
            font-size: 16px;
            font-weight: 600;
            color: #6200EE;
        }

        .helper-text {
            font-size: 14px;
            color: #666;
            font-style: italic;
            margin-top: 8px;
        }

        .amount-input-small {
            width: 80px;
            padding: 8px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            text-align: center;
        }

        .save-button {
            background: linear-gradient(135deg, #6200EE, #3700B3);
            color: white;
            padding: 18px;
            border-radius: 12px;
            border: none;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            box-shadow: 0 4px 12px rgba(98, 0, 238, 0.3);
            transition: all 0.3s ease;
        }

        .save-button:active {
            transform: scale(0.98);
        }

        .save-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .warning {
            background: #fff3e0;
            border: 1px solid #ff9800;
            color: #f57c00;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 16px;
        }

        .success {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            color: #388e3c;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 16px;
        }

        .auto-save {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4CAF50;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 1000;
        }

        .auto-save.show {
            opacity: 1;
        }

        .toggle-calc {
            background: #2196F3;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            margin-left: 8px;
        }

        .hidden {
            display: none;
        }

        .category-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 8px;
        }

        .category-button {
            background: white;
            border: 2px solid #e0e0e0;
            color: #666;
            padding: 12px 8px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .category-button.active {
            background: #6200EE;
            color: white;
            border-color: #6200EE;
        }

        .category-button:hover {
            border-color: #6200EE;
        }
    </style>
</head>
<body>
    <div class="auto-save" id="autoSave">
        üíæ Draft saved
    </div>

    <div class="header">
        <button class="back-button" onclick="goBack()">‚Üê</button>
        <div class="header-title">Add Expense</div>
        <div class="draft-indicator" id="draftIndicator">Draft</div>
    </div>

    <div class="container">
        <!-- Amount Section -->
        <div class="card">
            <div class="section-title">üí∞ How much was spent?</div>
            <div class="form-group">
                <label class="form-label">
                    Total Amount
                    <button class="toggle-calc" onclick="toggleCalculator()">üßÆ Calculator</button>
                </label>
                <input 
                    type="number" 
                    class="form-input amount-input" 
                    id="totalAmount" 
                    placeholder="0.00"
                    step="0.01"
                    oninput="handleAmountChange()"
                >
            </div>
            
            <!-- Built-in Calculator -->
            <div class="calculator-container hidden" id="calculator">
                <div class="calculator-display" id="calcDisplay">0</div>
                <div class="calculator-grid">
                    <button class="calc-button" onclick="clearCalc()">C</button>
                    <button class="calc-button" onclick="deleteLast()">‚å´</button>
                    <button class="calc-button operator" onclick="inputCalc('/')">/</button>
                    <button class="calc-button operator" onclick="inputCalc('*')">√ó</button>
                    
                    <button class="calc-button" onclick="inputCalc('7')">7</button>
                    <button class="calc-button" onclick="inputCalc('8')">8</button>
                    <button class="calc-button" onclick="inputCalc('9')">9</button>
                    <button class="calc-button operator" onclick="inputCalc('-')">-</button>
                    
                    <button class="calc-button" onclick="inputCalc('4')">4</button>
                    <button class="calc-button" onclick="inputCalc('5')">5</button>
                    <button class="calc-button" onclick="inputCalc('6')">6</button>
                    <button class="calc-button operator" onclick="inputCalc('+')">+</button>
                    
                    <button class="calc-button" onclick="inputCalc('1')">1</button>
                    <button class="calc-button" onclick="inputCalc('2')">2</button>
                    <button class="calc-button" onclick="inputCalc('3')">3</button>
                    <button class="calc-button equals" onclick="calculateResult()" rowspan="2">=</button>
                    
                    <button class="calc-button" onclick="inputCalc('0')" style="grid-column: span 2;">0</button>
                    <button class="calc-button" onclick="inputCalc('.')">.</button>
                </div>
            </div>
        </div>

        <!-- Description Section -->
        <div class="card">
            <div class="section-title">üìù What was this for?</div>
            <div class="form-group">
                <input 
                    type="text" 
                    class="form-input" 
                    id="description" 
                    placeholder="e.g., Lunch at Pizza Place"
                    oninput="autoSave()"
                >
            </div>
            
            <!-- Category Selection -->
            <div class="form-group">
                <label class="form-label">üè∑Ô∏è Category</label>
                <div class="category-grid">
                    <button type="button" class="category-button active" onclick="selectCategory('general')" id="cat-general">
                        üçΩÔ∏è General
                    </button>
                    <button type="button" class="category-button" onclick="selectCategory('food')" id="cat-food">
                        üçï Food & Drinks
                    </button>
                    <button type="button" class="category-button" onclick="selectCategory('transport')" id="cat-transport">
                        üöó Transport
                    </button>
                    <button type="button" class="category-button" onclick="selectCategory('accommodation')" id="cat-accommodation">
                        üè® Accommodation
                    </button>
                    <button type="button" class="category-button" onclick="selectCategory('entertainment')" id="cat-entertainment">
                        üé¨ Entertainment
                    </button>
                    <button type="button" class="category-button" onclick="selectCategory('shopping')" id="cat-shopping">
                        üõçÔ∏è Shopping
                    </button>
                </div>
            </div>
        </div>

        <!-- Quick Split Section -->
        <div class="card">
            <div class="section-title">üë• How many people?</div>
            
            <!-- Quick Split Buttons -->
            <div class="quick-split" id="quickSplitButtons">
                <!-- Buttons will be populated dynamically based on friends -->
            </div>
            
            <!-- Split Method -->
            <div class="split-method">
                <button class="method-button active" onclick="setSplitMethod('equal')" id="equalBtn">
                    Equal Split
                </button>
                <button class="method-button" onclick="setSplitMethod('custom')" id="customBtn">
                    Custom Amounts
                </button>
            </div>

            <!-- People List -->
            <div class="people-list" id="peopleList">
                <div class="person-item">
                    <div class="person-info">
                        <input type="checkbox" class="person-checkbox" id="person-0" checked onchange="togglePersonInExpense(0)">
                        <div class="person-name">You</div>
                    </div>
                    <div class="person-amount" id="yourAmount">$0.00</div>
                </div>
            </div>

            <!-- Add Person -->
            <div class="form-group">
                <input 
                    type="text" 
                    class="form-input" 
                    id="newPersonName" 
                    placeholder="Add person..."
                    onkeypress="handleAddPerson(event)"
                >
            </div>
            
            <div class="helper-text">
                üí° Tip: Uncheck people who didn't participate in this expense
            </div>
        </div>

        <!-- Validation Messages -->
        <div id="validationMessage"></div>

        <!-- Save Button -->
        <button class="save-button" onclick="saveExpense()" id="saveButton">
            üíæ Save Expense
        </button>
    </div>

    <script>
        let currentData = {
            amount: 0,
            description: '',
            category: 'general',
            people: ['You'],
            includedPeople: [true], // Track who's included in this expense
            splitMethod: 'equal',
            customAmounts: {}
        };

        let calcExpression = '';
        let calcDisplay = '0';

        // Auto-save functionality
        function autoSave() {
            updateCurrentData();
            localStorage.setItem('splitzee_draft', JSON.stringify(currentData));
            showAutoSaveIndicator();
        }

        function showAutoSaveIndicator() {
            const indicator = document.getElementById('autoSave');
            indicator.classList.add('show');
            setTimeout(() => indicator.classList.remove('show'), 2000);
        }

        function loadDraft() {
            const draft = localStorage.getItem('splitzee_draft');
            if (draft) {
                currentData = JSON.parse(draft);
                populateForm();
            }
        }

        function populateForm() {
            document.getElementById('totalAmount').value = currentData.amount || '';
            document.getElementById('description').value = currentData.description || '';
            
            // Restore category selection
            if (currentData.category) {
                selectCategory(currentData.category);
            }
            
            updatePeopleList();
            updateSplitAmounts();
        }

        function updateCurrentData() {
            currentData.amount = parseFloat(document.getElementById('totalAmount').value) || 0;
            currentData.description = document.getElementById('description').value;
        }
        
        function selectCategory(category) {
            // Remove active class from all category buttons
            document.querySelectorAll('.category-button').forEach(btn => btn.classList.remove('active'));
            
            // Add active class to selected category
            document.getElementById(`cat-${category}`).classList.add('active');
            
            currentData.category = category;
            autoSave();
        }

        // Calculator functions
        function toggleCalculator() {
            const calc = document.getElementById('calculator');
            calc.classList.toggle('hidden');
        }

        function inputCalc(value) {
            if (calcDisplay === '0' && value !== '.') {
                calcDisplay = value;
            } else {
                calcDisplay += value;
            }
            calcExpression += value;
            document.getElementById('calcDisplay').textContent = calcDisplay;
        }

        function clearCalc() {
            calcDisplay = '0';
            calcExpression = '';
            document.getElementById('calcDisplay').textContent = calcDisplay;
        }

        function deleteLast() {
            if (calcDisplay.length > 1) {
                calcDisplay = calcDisplay.slice(0, -1);
                calcExpression = calcExpression.slice(0, -1);
            } else {
                calcDisplay = '0';
                calcExpression = '';
            }
            document.getElementById('calcDisplay').textContent = calcDisplay;
        }

        function calculateResult() {
            try {
                const result = eval(calcExpression.replace('√ó', '*'));
                calcDisplay = result.toString();
                calcExpression = result.toString();
                document.getElementById('calcDisplay').textContent = calcDisplay;
                
                // Set the amount in the main input
                document.getElementById('totalAmount').value = result.toFixed(2);
                handleAmountChange();
            } catch (error) {
                calcDisplay = 'Error';
                document.getElementById('calcDisplay').textContent = calcDisplay;
            }
        }

        // Amount handling
        function handleAmountChange() {
            updateSplitAmounts();
            autoSave();
        }

        // Quick split functions
        function quickSplit(numberOfPeople) {
            // Remove all active classes
            document.querySelectorAll('.quick-button').forEach(btn => btn.classList.remove('active'));
            
            // Add active class to clicked button
            event.target.classList.add('active');
            
            // Set up people list with real friend names
            currentData.people = ['You'];
            currentData.includedPeople = [true];
            
            // Get friends from SupabaseSync
            const friends = window.SupabaseSync.getFriends();
            
            // Add friends based on selection
            if (numberOfPeople === 1) {
                // Just Me - no additional people
            } else {
                // Add the first (numberOfPeople - 1) friends
                for (let i = 0; i < numberOfPeople - 1; i++) {
                    if (i < friends.length) {
                        // Use real friend name
                        currentData.people.push(friends[i].name);
                        currentData.includedPeople.push(true);
                    } else {
                        // Fallback to generic name if not enough friends
                        currentData.people.push(`Person ${i + 2}`);
                        currentData.includedPeople.push(true);
                    }
                }
            }
            
            updatePeopleList();
            updateSplitAmounts();
            autoSave();
        }

        function setSplitMethod(method) {
            currentData.splitMethod = method;
            
            document.getElementById('equalBtn').classList.toggle('active', method === 'equal');
            document.getElementById('customBtn').classList.toggle('active', method === 'custom');
            
            updatePeopleList();
            autoSave();
        }

        function updatePeopleList() {
            const list = document.getElementById('peopleList');
            list.innerHTML = '';
            
            currentData.people.forEach((person, index) => {
                const item = document.createElement('div');
                const isIncluded = currentData.includedPeople[index];
                item.className = `person-item ${!isIncluded ? 'excluded' : ''}`;
                
                if (currentData.splitMethod === 'equal') {
                    item.innerHTML = `
                        <div class="person-info">
                            <input type="checkbox" class="person-checkbox" id="person-${index}" 
                                   ${isIncluded ? 'checked' : ''} 
                                   onchange="togglePersonInExpense(${index})">
                            <div class="person-name">${person}</div>
                        </div>
                        <div class="person-amount" id="amount-${index}">$0.00</div>
                    `;
                } else {
                    item.innerHTML = `
                        <div class="person-info">
                            <input type="checkbox" class="person-checkbox" id="person-${index}" 
                                   ${isIncluded ? 'checked' : ''} 
                                   onchange="togglePersonInExpense(${index})">
                            <div class="person-name">${person}</div>
                        </div>
                        <input type="number" class="amount-input-small" 
                               placeholder="0.00" step="0.01"
                               onchange="updateCustomAmount(${index}, this.value)"
                               value="${currentData.customAmounts[index] || ''}"
                               ${!isIncluded ? 'disabled' : ''}>
                    `;
                }
                
                list.appendChild(item);
            });
        }
        
        function togglePersonInExpense(index) {
            currentData.includedPeople[index] = !currentData.includedPeople[index];
            
            // Ensure at least one person is included
            const anyIncluded = currentData.includedPeople.some(included => included);
            if (!anyIncluded) {
                currentData.includedPeople[index] = true;
                showValidationMessage('At least one person must be included in the expense', 'warning');
                return;
            }
            
            updatePeopleList();
            updateSplitAmounts();
            autoSave();
        }

        function updateCustomAmount(index, value) {
            currentData.customAmounts[index] = parseFloat(value) || 0;
            validateAmounts();
            autoSave();
        }

        function updateSplitAmounts() {
            const totalAmount = parseFloat(document.getElementById('totalAmount').value) || 0;
            
            if (currentData.splitMethod === 'equal') {
                // Only count included people for split calculation
                const includedCount = currentData.includedPeople.filter(included => included).length;
                const perPerson = includedCount > 0 ? totalAmount / includedCount : 0;
                
                currentData.people.forEach((person, index) => {
                    const amountElement = document.getElementById(`amount-${index}`);
                    if (amountElement) {
                        const amount = currentData.includedPeople[index] ? perPerson : 0;
                        amountElement.textContent = `$${amount.toFixed(2)}`;
                    }
                });
            }
            
            validateAmounts();
        }

        function validateAmounts() {
            const totalAmount = parseFloat(document.getElementById('totalAmount').value) || 0;
            const messageDiv = document.getElementById('validationMessage');
            
            if (currentData.splitMethod === 'custom') {
                const customTotal = Object.values(currentData.customAmounts).reduce((sum, amount) => sum + (amount || 0), 0);
                const difference = Math.abs(totalAmount - customTotal);
                
                if (difference > 0.01) {
                    messageDiv.innerHTML = `
                        <div class="warning">
                            ‚ö†Ô∏è Amounts don't add up perfectly (off by $${difference.toFixed(2)}). 
                            You can still save this expense.
                        </div>
                    `;
                } else {
                    messageDiv.innerHTML = `<div class="success">‚úÖ Amounts add up perfectly!</div>`;
                }
            } else {
                messageDiv.innerHTML = '';
            }
        }

        function updatePeopleList() {
            const peopleListContainer = document.getElementById('peopleList');
            if (!peopleListContainer) return;
            
            let html = '';
            
            for (let i = 0; i < currentData.people.length; i++) {
                const person = currentData.people[i];
                const isIncluded = currentData.includedPeople[i];
                const isYou = person === 'You';
                
                html += `
                    <div class="person-item ${isIncluded ? 'included' : ''}" data-index="${i}">
                        <div class="person-info">
                            <div class="person-checkbox">
                                <input type="checkbox" 
                                       ${isIncluded ? 'checked' : ''} 
                                       ${isYou ? 'disabled' : ''}
                                       onchange="togglePersonInclusion(${i})">
                            </div>
                            <div class="person-name">${person}</div>
                        </div>
                        <div class="person-amount">
                            ${currentData.splitMethod === 'custom' ? 
                                `<input type="number" 
                                        class="custom-amount-input" 
                                        value="${(currentData.customAmounts && currentData.customAmounts[i]) || 0}" 
                                        onchange="updateCustomAmount(${i}, this.value)"
                                        step="0.01"
                                        ${!isIncluded ? 'disabled' : ''}>` 
                                : 
                                `$${isIncluded ? ((currentData.amount || 0) / currentData.includedPeople.filter(Boolean).length).toFixed(2) : '0.00'}`
                            }
                        </div>
                        ${!isYou ? `<button class="remove-person-btn" onclick="removePerson(${i})">√ó</button>` : ''}
                    </div>
                `;
            }
            
            peopleListContainer.innerHTML = html;
        }

        function togglePersonInclusion(index) {
            if (index === 0) return; // Can't exclude "You"
            currentData.includedPeople[index] = !currentData.includedPeople[index];
            updatePeopleList();
            updateSplitAmounts();
            autoSave();
        }

        function removePerson(index) {
            if (index === 0) return; // Can't remove "You"
            currentData.people.splice(index, 1);
            currentData.includedPeople.splice(index, 1);
            if (currentData.customAmounts) {
                currentData.customAmounts.splice(index, 1);
            }
            updatePeopleList();
            updateSplitAmounts();
            autoSave();
        }

        function updateCustomAmount(index, value) {
            if (!currentData.customAmounts) {
                currentData.customAmounts = new Array(currentData.people.length).fill(0);
            }
            currentData.customAmounts[index] = parseFloat(value) || 0;
            updateSplitAmounts();
            autoSave();
        }

        function updateSplitAmounts() {
            const totalAmount = currentData.amount || 0;
            const includedCount = currentData.includedPeople.filter(Boolean).length;
            
            if (currentData.splitMethod === 'equal') {
                // Equal split - each included person pays the same amount
                const amountPerPerson = includedCount > 0 ? totalAmount / includedCount : 0;
                
                // Update the display
                updatePeopleList();
                
                // Update validation
                validateAmounts();
            } else if (currentData.splitMethod === 'custom') {
                // Custom amounts - validate they add up
                if (!currentData.customAmounts) {
                    currentData.customAmounts = new Array(currentData.people.length).fill(0);
                }
                
                // Update the display
                updatePeopleList();
                
                // Update validation
                validateAmounts();
            }
        }

        function autoSave() {
            // Save current data as draft
            try {
                localStorage.setItem('splitzee_draft', JSON.stringify(currentData));
                console.log('üíæ Draft auto-saved');
            } catch (error) {
                console.error('Failed to auto-save draft:', error);
            }
        }

        function handleAddPerson(event) {
            if (event.key === 'Enter') {
                const input = event.target;
                const name = input.value.trim();
                
                if (name && !currentData.people.includes(name)) {
                    currentData.people.push(name);
                    currentData.includedPeople.push(true); // Include new person by default
                    input.value = '';
                    updatePeopleList();
                    updateSplitAmounts();
                    autoSave();
                }
            }
        }

        async function saveExpense() {
            updateCurrentData();
            
            if (!currentData.amount) {
                showValidationMessage('Please enter an amount', 'warning');
                return;
            }
            
            if (!currentData.description) {
                showValidationMessage('Please enter a description', 'warning');
                return;
            }
            
            // Show saving indicator
            const saveButton = document.getElementById('saveButton');
            saveButton.disabled = true;
            saveButton.innerHTML = 'üíæ Saving...';
            
            try {
                // Get current user
                const user = window.SupabaseSync.getUser();
                if (!user) {
                    throw new Error('User not initialized');
                }
                
                // Check if user can create expense (freemium)
                if (!user.isPremium) {
                    const stats = window.SupabaseSync.getUsageStats();
                    if (stats.expensesThisMonth >= 5) {
                        showValidationMessage('You\'ve reached the monthly limit of 5 expenses. Upgrade to Premium for unlimited expenses! üíé', 'warning');
                        setTimeout(() => { window.location.href = 'premium.html'; }, 2000);
                        return;
                    }
                }
                
                // Calculate splits (only for included people)
                const includedPeople = currentData.people.filter((person, index) => currentData.includedPeople[index]);
                const perPerson = currentData.amount / includedPeople.length;
                const splits = {};
                
                if (currentData.splitMethod === 'equal') {
                    currentData.people.forEach((person, index) => {
                        if (currentData.includedPeople[index]) {
                            splits[person] = perPerson;
                        }
                    });
                } else {
                    currentData.people.forEach((person, index) => {
                        if (currentData.includedPeople[index]) {
                            splits[person] = currentData.customAmounts[index] || 0;
                        }
                    });
                }
                
                // Save expense to database
                const expense = {
                    amount: currentData.amount,
                    description: currentData.description,
                    category: currentData.category,
                    splitType: currentData.splitMethod === 'equal' ? 'equal' : 'custom',
                    splits: splits,
                    participants: includedPeople
                };
                
                // Check if we're editing an existing expense
                if (currentData.id) {
                    // Update existing expense
                    await window.SupabaseSync.updateExpense(currentData.id, expense);
                } else {
                    // Create new expense
                    await window.SupabaseSync.createExpense(expense);
                }
                
                // Clear draft and edit data
                localStorage.removeItem('splitzee_draft');
                localStorage.removeItem('splitzee_edit_expense_id');
                
                const successMessage = currentData.id ? 'Expense updated successfully! üéâ' : 'Expense saved successfully! üéâ';
                showValidationMessage(successMessage, 'success');
                
                setTimeout(() => {
                    window.location.href = 'production-app.html';
                }, 1500);
                
            } catch (error) {
                console.error('Error saving expense:', error);
                showValidationMessage('Failed to save expense: ' + error.message, 'warning');
                
                // Re-enable button
                saveButton.disabled = false;
                saveButton.innerHTML = 'üíæ Save Expense';
            }
        }
        
        function showValidationMessage(message, type) {
            const messageDiv = document.getElementById('validationMessage');
            const className = type === 'success' ? 'success' : 'warning';
            
            messageDiv.innerHTML = `<div class="${className}">${message}</div>`;
            
            // Clear after 5 seconds
            setTimeout(() => {
                if (type !== 'success') { // Don't clear success messages automatically
                    messageDiv.innerHTML = '';
                }
            }, 5000);
        }

        function goBack() {
            if (localStorage.getItem('splitzee_draft')) {
                if (confirm('You have unsaved changes. Do you want to leave without saving?')) {
                    localStorage.removeItem('splitzee_draft');
                    window.location.href = 'production-app.html';
                }
            } else {
                window.location.href = 'production-app.html';
            }
        }

        function initializeFriendsList() {
            console.log('üîÑ Initializing friends list...');
            
            if (!window.SupabaseSync) {
                console.log('‚ùå SupabaseSync not available yet');
                setTimeout(initializeFriendsList, 200); // Retry in 200ms
                return;
            }
            
            const friends = window.SupabaseSync.getFriends();
            console.log('üë• Found friends:', friends.length, friends);
            
            // Generate quick split buttons based on friends
            const quickSplitContainer = document.getElementById('quickSplitButtons');
            if (!quickSplitContainer) {
                console.log('‚ùå Quick split container not found');
                return;
            }
            
            let buttonsHtml = '';
            
            if (friends.length === 0) {
                // No friends - only show "Just Me" option
                buttonsHtml = '<button class="quick-button" onclick="quickSplit(1)">Just Me</button>';
                
                // Initialize with just you
                currentData.people = ['You'];
                currentData.includedPeople = [true];
            } else {
                // Show friend-specific options
                buttonsHtml += '<button class="quick-button" onclick="quickSplit(1)">Just Me</button>';
                
                // Add specific friend buttons
                for (let i = 0; i < Math.min(friends.length, 3); i++) {
                    const friendName = friends[i].name;
                    buttonsHtml += `<button class="quick-button" onclick="quickSplitWithFriend('${friendName}')">Me + ${friendName}</button>`;
                }
                
                // Add a button for all friends if you have multiple
                if (friends.length > 1) {
                    buttonsHtml += `<button class="quick-button" onclick="quickSplit(${friends.length + 1})">Me + All Friends</button>`;
                }
                
                // Initialize with all friends by default
                currentData.people = ['You'];
                currentData.includedPeople = [true];
                
                friends.forEach(friend => {
                    currentData.people.push(friend.name);
                    currentData.includedPeople.push(true);
                });
                
                console.log('‚úÖ Initialized with friends:', currentData.people);
            }
            
            quickSplitContainer.innerHTML = buttonsHtml;
            updatePeopleList();
            updateSplitAmounts();
        }
        
        // New function for friend-specific splitting
        function quickSplitWithFriend(friendName) {
            // Remove all active classes
            document.querySelectorAll('.quick-button').forEach(btn => btn.classList.remove('active'));
            
            // Add active class to clicked button
            event.target.classList.add('active');
            
            // Set up people list with you and the specific friend
            currentData.people = ['You', friendName];
            currentData.includedPeople = [true, true];
            
            updatePeopleList();
            updateSplitAmounts();
            autoSave();
        }
        
        // Check if we're in edit mode
        function getEditExpenseId() {
            const urlParams = new URLSearchParams(window.location.search);
            
            // If URL has 'new' parameter, it's explicitly a new expense
            if (urlParams.get('new')) {
                return null;
            }
            
            return urlParams.get('edit') || localStorage.getItem('splitzee_edit_expense_id');
        }
        
        function loadExistingExpense(expenseId) {
            console.log('üìù Loading expense for editing:', expenseId);
            
            const expenses = window.SupabaseSync.getExpenses();
            const expense = expenses.find(e => e.id === expenseId);
            
            if (!expense) {
                console.error('‚ùå Expense not found:', expenseId);
                showValidationMessage('Expense not found', 'warning');
                return false;
            }
            
            console.log('‚úÖ Found expense:', expense);
            
            // Populate form with existing data
            document.getElementById('totalAmount').value = expense.amount;
            document.getElementById('description').value = expense.description;
            
            // Set category
            if (expense.category) {
                selectCategory(expense.category);
            }
            
            // Update currentData with expense data
            currentData = {
                id: expense.id, // Store ID for updating
                amount: expense.amount,
                description: expense.description,
                category: expense.category || 'general',
                people: expense.participants || ['You'],
                includedPeople: (expense.participants || ['You']).map(() => true),
                splitMethod: expense.splitType === 'custom' ? 'custom' : 'equal',
                customAmounts: {}
            };
            
            // If custom splits, populate custom amounts
            if (expense.splits && expense.splitType === 'custom') {
                expense.participants.forEach((person, index) => {
                    if (expense.splits[person]) {
                        currentData.customAmounts[index] = expense.splits[person];
                    }
                });
            }
            
            // Update header to show edit mode
            document.querySelector('.header-title').textContent = 'Edit Expense';
            document.querySelector('.draft-indicator').textContent = 'Editing';
            
            // Update save button
            document.getElementById('saveButton').innerHTML = 'üíæ Update Expense';
            
            updatePeopleList();
            updateSplitAmounts();
            
            console.log('‚úÖ Expense loaded for editing');
            return true;
        }
        
        // Initialize a completely new expense
        function initializeNewExpense() {
            console.log('üÜï Initializing new expense form');
            
            // Reset form to defaults
            document.getElementById('totalAmount').value = '';
            document.getElementById('description').value = '';
            
            // Reset category to general
            selectCategory('general');
            
            // Reset to default data structure
            currentData = {
                amount: 0,
                description: '',
                category: 'general',
                people: ['You'],
                includedPeople: [true],
                splitMethod: 'equal',
                customAmounts: {}
            };
            
            // Update UI elements
            document.querySelector('.header-title').textContent = 'Add Expense';
            document.querySelector('.draft-indicator').textContent = 'Draft';
            document.getElementById('saveButton').innerHTML = 'üíæ Save Expense';
            
            updatePeopleList();
            updateSplitAmounts();
            
            console.log('‚úÖ New expense form initialized');
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ DOM Content Loaded');
            
            // Initialize friends list and ensure test friends exist
            function initializeFriendsList() {
                try {
                    const friends = window.SupabaseSync.getFriends();
                    if (friends.length === 0) {
                        // Add some test friends for demonstration
                        const data = JSON.parse(localStorage.getItem('splitzee_data') || '{}');
                        if (!data.friends) data.friends = {};
                        
                        const testFriends = [
                            { id: 'friend_1', name: 'Alice', avatar: 'üë©' },
                            { id: 'friend_2', name: 'Bob', avatar: 'üë®' },
                            { id: 'friend_3', name: 'Charlie', avatar: 'üßë' }
                        ];
                        
                        testFriends.forEach(friend => {
                            data.friends[friend.id] = {
                                ...friend,
                                added: Date.now()
                            };
                        });
                        
                        localStorage.setItem('splitzee_data', JSON.stringify(data));
                        console.log('‚úÖ Added test friends: Alice, Bob, Charlie');
                    } else {
                        console.log(`‚úÖ Found ${friends.length} existing friends`);
                    }
                } catch (error) {
                    console.error('Error initializing friends list:', error);
                }
            }
            
            // Wait for SupabaseSync to be ready with progressive retry
            function waitForSupabaseSync() {
                if (window.SupabaseSync) {
                    console.log('‚úÖ SupabaseSync available, initializing...');
                    initializeFriendsList();
                    
                    // Check if we're editing an expense
                    const editExpenseId = getEditExpenseId();
                    if (editExpenseId) {
                        console.log('üîÑ Loading existing expense for editing:', editExpenseId);
                        loadExistingExpense(editExpenseId);
                    } else {
                        console.log('‚úÖ Starting fresh expense form');
                        // Clear any stale data for new expenses
                        const urlParams = new URLSearchParams(window.location.search);
                        if (urlParams.get('new')) {
                            localStorage.removeItem('splitzee_draft');
                            localStorage.removeItem('splitzee_edit_expense_id');
                            initializeNewExpense();
                        } else {
                            loadDraft();
                        }
                    }
                } else {
                    console.log('‚è≥ Waiting for SupabaseSync...');
                    setTimeout(waitForSupabaseSync, 100);
                }
            }
            
            waitForSupabaseSync();
            
            // Auto-save every 2 seconds
            setInterval(autoSave, 2000);
            
            console.log('üöÄ Splitzee Expense Form - UX Optimized!');
            console.log('‚úÖ Auto-save enabled');
            console.log('üßÆ Built-in calculator');
            console.log('‚ö° Dynamic friend-based split options');
            console.log('üí™ Flexible validation');
        });

        // Prevent data loss on page unload
        window.addEventListener('beforeunload', function(e) {
            autoSave();
        });
    </script>
</body>
</html>